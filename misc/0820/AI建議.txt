ä»¥ä¸‹æ˜¯å•é¡Œåˆ†æå’Œè§£æ±ºæ–¹æ¡ˆï¼š
ğŸ”´ ä¸»è¦å•é¡Œè¨ºæ–·
1. Kç·šæ•¸æ“šåŒ…å« null å€¼å•é¡Œ
éŒ¯èª¤ç™¼ç”Ÿåœ¨ updateData å¾Œï¼Œå¯èƒ½æ˜¯æ•¸æ“šä¸­æœ‰ null/undefined å€¼ã€‚
2. FVG æ¸²æŸ“å™¨çš„ç·šæ¢æ•¸æ“šå•é¡Œ
FVGæ¸²æŸ“å™¨å‰µå»ºäº†å¤šæ¢ç·šï¼Œä½†æŸäº›ç·šæ¢çš„æ•¸æ“šé»å¯èƒ½æ˜¯ nullã€‚
3. æ™‚é–“æˆ³æ ¼å¼å•é¡Œ
å¯èƒ½ startTime æˆ– endTime æ˜¯ null æˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚
ğŸ“ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
ä¿®æ”¹ 1: chart-manager.js - åŠ å…¥æ•¸æ“šé©—è­‰
javascript// æª”åï¼šchart-manager-fixed.js
// åœ¨ updateData æ–¹æ³•ä¸­åŠ å…¥æ•¸æ“šé©—è­‰

updateData(data) {
    if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn('updateData: ç„¡æ•ˆæˆ–ç©ºæ•¸æ“š');
        return [];
    }
    
    // éæ¿¾å’Œé©—è­‰æ•¸æ“š
    const validData = data.filter(item => {
        // æª¢æŸ¥å¿…è¦æ¬„ä½æ˜¯å¦å­˜åœ¨ä¸”ä¸ç‚º null
        return item && 
               item.time !== null && item.time !== undefined &&
               item.open !== null && item.open !== undefined &&
               item.high !== null && item.high !== undefined &&
               item.low !== null && item.low !== undefined &&
               item.close !== null && item.close !== undefined &&
               !isNaN(item.open) && !isNaN(item.high) && 
               !isNaN(item.low) && !isNaN(item.close);
    });
    
    if (validData.length === 0) {
        console.error('updateData: æ²’æœ‰æœ‰æ•ˆæ•¸æ“š');
        return [];
    }
    
    const candleData = validData.map(item => ({
        time: item.time,
        open: parseFloat(item.open),
        high: parseFloat(item.high),
        low: parseFloat(item.low),
        close: parseFloat(item.close),
    }));
    
    console.log('æ›´æ–°Kç·šæ•¸æ“š:', candleData.length, 'æ ¹');
    console.log('ç¬¬ä¸€æ ¹Kç·š:', candleData[0]);
    console.log('æœ€å¾Œä¸€æ ¹Kç·š:', candleData[candleData.length - 1]);
    
    try {
        this.candlestickSeries.setData(candleData);
    } catch (error) {
        console.error('è¨­ç½®Kç·šæ•¸æ“šå¤±æ•—:', error);
        // å˜—è©¦é‡æ–°å‰µå»ºç³»åˆ—
        this.recreateCandlestickSeries();
        this.candlestickSeries.setData(candleData);
    }
    
    return candleData;
}

// æ–°å¢æ–¹æ³•ï¼šé‡æ–°å‰µå»ºKç·šç³»åˆ—
recreateCandlestickSeries() {
    console.log('é‡æ–°å‰µå»ºKç·šç³»åˆ—...');
    if (this.candlestickSeries) {
        try {
            this.chart.removeSeries(this.candlestickSeries);
        } catch (e) {
            console.warn('ç§»é™¤èˆŠç³»åˆ—å¤±æ•—:', e);
        }
    }
    this.candlestickSeries = this.createCandlestickSeries();
}
ä¿®æ”¹ 2: fvg-renderer-multiline.js - ä¿®å¾©ç·šæ¢æ•¸æ“š
javascript// æª”åï¼šfvg-renderer-multiline-fixed.js
// ä¿®æ”¹ renderSingleFVG æ–¹æ³•ä¸­çš„ç·šæ¢æ•¸æ“šå‰µå»º

renderSingleFVG(fvg, index, isCleared) {
    try {
        // é©—è­‰ FVG æ•¸æ“š
        if (!fvg || !fvg.startTime || !fvg.endTime) {
            console.error(`âŒ FVG ${index + 1} ç¼ºå°‘æ™‚é–“æ•¸æ“š:`, fvg);
            return;
        }
        
        // ç¢ºä¿åƒ¹æ ¼æ˜¯æ•¸å­—ä¸”æœ‰æ•ˆ
        const topPrice = this.validatePrice(fvg.topPrice || fvg.endPrice || fvg.startPrice);
        const bottomPrice = this.validatePrice(fvg.bottomPrice || fvg.startPrice || fvg.endPrice);
        
        if (topPrice === null || bottomPrice === null) {
            console.error(`âŒ FVG ${index + 1} åƒ¹æ ¼ç„¡æ•ˆ:`, fvg);
            return;
        }
        
        // ç¢ºä¿æ™‚é–“æˆ³æœ‰æ•ˆ
        const startTime = this.validateTime(fvg.startTime);
        const endTime = this.validateTime(fvg.endTime);
        
        if (startTime === null || endTime === null) {
            console.error(`âŒ FVG ${index + 1} æ™‚é–“ç„¡æ•ˆ:`, fvg);
            return;
        }
        
        console.log(`ğŸ”¹ æ¸²æŸ“FVG ${index + 1}: ${fvg.type} (${topPrice.toFixed(2)} - ${bottomPrice.toFixed(2)})`);
        
        const fvgGapSize = Math.abs(topPrice - bottomPrice);
        const numberOfFillLines = this.calculateLineCount(fvgGapSize);
        
        const fillColor = this.getFillColor(fvg.type, isCleared);
        const borderColor = this.getBorderColor(fvg.type, isCleared);
        
        // å‰µå»ºå¡«å……ç·šæ¢ - ç¢ºä¿æ‰€æœ‰å€¼éƒ½æœ‰æ•ˆ
        for (let i = 1; i < numberOfFillLines; i++) {
            const ratio = i / numberOfFillLines;
            const linePrice = bottomPrice + (topPrice - bottomPrice) * ratio;
            
            // é©—è­‰ç·šåƒ¹æ ¼
            if (isNaN(linePrice) || linePrice === null) {
                console.warn(`è·³éç„¡æ•ˆç·šæ¢åƒ¹æ ¼: ${linePrice}`);
                continue;
            }
            
            const fillLineSeries = this.createLineSeries({
                color: fillColor,
                lineWidth: 1,
                lineStyle: 0, // ä½¿ç”¨æ•¸å­—è€Œéå¸¸é‡
                priceScaleId: 'right',
                lastValueVisible: false,
                priceLineVisible: false,
            });
            
            const lineData = [
                { time: startTime, value: linePrice },
                { time: endTime, value: linePrice }
            ];
            
            try {
                fillLineSeries.setData(lineData);
                this.fvgPrimitives.push(fillLineSeries);
            } catch (error) {
                console.error(`å‰µå»ºç·šæ¢å¤±æ•— (price: ${linePrice}):`, error);
            }
        }
        
        // å‰µå»ºé‚Šç•Œç·š
        this.createSafeBoundaryLine(topPrice, startTime, endTime, borderColor, isCleared);
        this.createSafeBoundaryLine(bottomPrice, startTime, endTime, borderColor, isCleared);
        
    } catch (error) {
        console.error(`âŒ FVGæ¸²æŸ“å¤±æ•— [${index}]:`, error);
    }
}

// æ–°å¢è¼”åŠ©æ–¹æ³•ï¼šé©—è­‰åƒ¹æ ¼
validatePrice(price) {
    if (price === null || price === undefined || isNaN(price)) {
        return null;
    }
    return parseFloat(price);
}

// æ–°å¢è¼”åŠ©æ–¹æ³•ï¼šé©—è­‰æ™‚é–“
validateTime(time) {
    if (time === null || time === undefined) {
        return null;
    }
    // å¦‚æœæ˜¯æ•¸å­—ï¼Œç›´æ¥è¿”å›
    if (typeof time === 'number' && !isNaN(time)) {
        return time;
    }
    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå˜—è©¦è§£æ
    if (typeof time === 'string') {
        const parsed = parseFloat(time);
        if (!isNaN(parsed)) {
            return parsed;
        }
    }
    return null;
}

// æ–°å¢å®‰å…¨çš„é‚Šç•Œç·šå‰µå»ºæ–¹æ³•
createSafeBoundaryLine(price, startTime, endTime, color, isCleared) {
    if (price === null || startTime === null || endTime === null) {
        console.warn('è·³éç„¡æ•ˆé‚Šç•Œç·š');
        return null;
    }
    
    try {
        const lineSeries = this.createLineSeries({
            color: color,
            lineWidth: 0.5,
            lineStyle: isCleared ? 2 : 0, // ä½¿ç”¨æ•¸å­—ä»£æ›¿å¸¸é‡
            priceScaleId: 'right',
            lastValueVisible: false,
            priceLineVisible: false,
        });
        
        const lineData = [
            { time: startTime, value: price },
            { time: endTime, value: price }
        ];
        
        lineSeries.setData(lineData);
        this.fvgPrimitives.push(lineSeries);
        return lineSeries;
    } catch (error) {
        console.error(`å‰µå»ºé‚Šç•Œç·šå¤±æ•— (price: ${price}):`, error);
        return null;
    }
}
ä¿®æ”¹ 3: script-v2.js - åŠ å…¥æ•¸æ“šæª¢æŸ¥
javascript// æª”åï¼šscript-v2-fixed.js
// ä¿®æ”¹ loadInitialData å‡½æ•¸

async function loadInitialData() {
    showLoading();
    
    try {
        const data = await dataManager.loadRandomData(currentTimeframe);
        
        if (!data) {
            console.error('æ²’æœ‰æ”¶åˆ°æ•¸æ“š');
            hideLoading();
            return;
        }
        
        // é©—è­‰æ•¸æ“šçµæ§‹
        if (!data.data || !Array.isArray(data.data)) {
            console.error('æ•¸æ“šæ ¼å¼éŒ¯èª¤:', data);
            alert('æ•¸æ“šæ ¼å¼éŒ¯èª¤');
            hideLoading();
            return;
        }
        
        // æª¢æŸ¥æ•¸æ“šä¸­æ˜¯å¦æœ‰ null å€¼
        const hasNullValues = data.data.some(item => 
            !item || 
            item.time === null || item.time === undefined ||
            item.open === null || item.open === undefined ||
            item.high === null || item.high === undefined ||
            item.low === null || item.low === undefined ||
            item.close === null || item.close === undefined
        );
        
        if (hasNullValues) {
            console.warn('æ•¸æ“šä¸­åŒ…å« null å€¼ï¼Œé€²è¡Œæ¸…ç†...');
            // éæ¿¾æ‰åŒ…å« null çš„æ•¸æ“šé»
            data.data = data.data.filter(item => 
                item && 
                item.time !== null && item.time !== undefined &&
                item.open !== null && item.open !== undefined &&
                item.high !== null && item.high !== undefined &&
                item.low !== null && item.low !== undefined &&
                item.close !== null && item.close !== undefined
            );
        }
        
        if (data.data.length === 0) {
            console.error('æ²’æœ‰æœ‰æ•ˆçš„Kç·šæ•¸æ“š');
            alert('æ²’æœ‰æœ‰æ•ˆçš„Kç·šæ•¸æ“š');
            hideLoading();
            return;
        }
        
        console.log('è¼‰å…¥æ•¸æ“šæˆåŠŸ:', data.data.length, 'æ ¹Kç·š');
        currentData = data;
        updateUI(data);
        hideLoading();
        
    } catch (error) {
        console.error('è¼‰å…¥åˆå§‹è³‡æ–™å¤±æ•—:', error);
        alert('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        hideLoading();
    }
}
ä¿®æ”¹ 4: ä½¿ç”¨CanvasåŸç”Ÿç¹ªè£½FVGçŸ©å½¢ï¼ˆæ›´å¥½çš„æ–¹æ¡ˆï¼‰
å¦‚æœè¦é¡¯ç¤ºçœŸæ­£çš„åŠé€æ˜çŸ©å½¢è€Œä¸æ˜¯å¤šæ¢ç·šï¼Œå»ºè­°å‰µå»ºä¸€å€‹æ–°çš„FVGæ¸²æŸ“å™¨ï¼š
javascript// æª”åï¼šfvg-renderer-rect.js
// ä½¿ç”¨è‡ªå®šç¾©æ’ä»¶ç¹ªè£½çœŸæ­£çš„çŸ©å½¢

class FVGRendererRect {
    constructor(chart, candlestickSeries) {
        this.chart = chart;
        this.candlestickSeries = candlestickSeries;
        this.fvgData = [];
        this.plugin = null;
        this.initPlugin();
    }
    
    initPlugin() {
        const self = this;
        
        this.plugin = {
            renderer: () => ({
                draw: (target) => {
                    const ctx = target.context;
                    const bitmapSize = target.bitmapSize;
                    
                    // éæ­·æ‰€æœ‰FVGä¸¦ç¹ªè£½
                    self.fvgData.forEach(fvg => {
                        if (!fvg.startTime || !fvg.endTime || !fvg.topPrice || !fvg.bottomPrice) {
                            return;
                        }
                        
                        try {
                            // è½‰æ›æ™‚é–“å’Œåƒ¹æ ¼åˆ°ç•«å¸ƒåæ¨™
                            const x1 = self.chart.timeScale().timeToCoordinate(fvg.startTime);
                            const x2 = self.chart.timeScale().timeToCoordinate(fvg.endTime);
                            const y1 = self.candlestickSeries.priceToCoordinate(fvg.topPrice);
                            const y2 = self.candlestickSeries.priceToCoordinate(fvg.bottomPrice);
                            
                            if (x1 === null || x2 === null || y1 === null || y2 === null) {
                                return;
                            }
                            
                            // è¨­ç½®æ¨£å¼
                            ctx.save();
                            
                            // æ ¹æ“šé¡å‹è¨­ç½®é¡è‰²
                            if (fvg.type === 'bullish') {
                                ctx.fillStyle = fvg.isCleared ? 'rgba(128, 128, 128, 0.1)' : 'rgba(0, 255, 140, 0.15)';
                                ctx.strokeStyle = fvg.isCleared ? '#888888' : '#00d68f';
                            } else {
                                ctx.fillStyle = fvg.isCleared ? 'rgba(128, 128, 128, 0.1)' : 'rgba(255, 61, 113, 0.15)';
                                ctx.strokeStyle = fvg.isCleared ? '#888888' : '#ff3d71';
                            }
                            
                            ctx.lineWidth = 1;
                            
                            // ç¹ªè£½çŸ©å½¢
                            const width = Math.abs(x2 - x1);
                            const height = Math.abs(y2 - y1);
                            const x = Math.min(x1, x2);
                            const y = Math.min(y1, y2);
                            
                            // å¡«å……
                            ctx.fillRect(x, y, width, height);
                            
                            // é‚Šæ¡†
                            ctx.strokeRect(x, y, width, height);
                            
                            ctx.restore();
                            
                        } catch (error) {
                            console.error('ç¹ªè£½FVGå¤±æ•—:', error);
                        }
                    });
                }
            })
        };
        
        // å°‡æ’ä»¶é™„åŠ åˆ°åœ–è¡¨
        this.chart.applyOptions({
            plugins: [this.plugin]
        });
    }
    
    render(fvgs) {
        // è½‰æ›FVGæ•¸æ“šæ ¼å¼
        this.fvgData = fvgs.filter(fvg => fvg && fvg.startTime && fvg.endTime).map(fvg => ({
            startTime: fvg.startTime,
            endTime: fvg.endTime,
            topPrice: parseFloat(fvg.topPrice || fvg.endPrice || fvg.startPrice),
            bottomPrice: parseFloat(fvg.bottomPrice || fvg.startPrice || fvg.endPrice),
            type: fvg.type,
            isCleared: fvg.status === 'cleared'
        }));
        
        // è«‹æ±‚é‡ç¹ª
        this.chart.applyOptions({});
    }
}
ğŸš€ ç«‹å³åŸ·è¡Œçš„æ­¥é©Ÿ

å…ˆä¿®å¾©æ•¸æ“šé©—è­‰å•é¡Œï¼ˆä¿®æ”¹1å’Œ3ï¼‰
ä¿®å¾©FVGæ¸²æŸ“å™¨çš„nullå€¼å•é¡Œï¼ˆä¿®æ”¹2ï¼‰
è€ƒæ…®æ”¹ç”¨CanvasåŸç”Ÿç¹ªè£½ï¼ˆä¿®æ”¹4ï¼‰ä»¥ç²å¾—çœŸæ­£çš„åŠé€æ˜çŸ©å½¢

æœ€é—œéµçš„æ˜¯è¦ç¢ºä¿æ‰€æœ‰å‚³å…¥åœ–è¡¨çš„æ•¸æ“šéƒ½ä¸åŒ…å« null å€¼ï¼