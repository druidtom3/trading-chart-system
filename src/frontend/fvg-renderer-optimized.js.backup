/**
 * FVG Optimized Renderer - åŸºæ–¼åƒè€ƒå°ˆæ¡ˆçš„é«˜æ€§èƒ½å¯¦ç¾
 * ä½¿ç”¨ createPriceLine è€Œä¸æ˜¯å¤§é‡ LineSeries
 */

class FVGRendererOptimized {
    constructor(chart, candlestickSeries) {
        this.chart = chart;
        this.candlestickSeries = candlestickSeries;
        this.priceLines = [];
        this.markers = [];
        this.settings = {
            showFVG: true,
            showFVGMarkers: false,
            showClearedFVGs: false,  // ä¿®æ­£ï¼šé è¨­ä¸é¡¯ç¤ºå·²æ¸…é™¤FVGï¼Œèˆ‡é…ç½®ä¿æŒä¸€è‡´
            maxFVGsPerType: 50
        };
        
        console.log('âš¡ FVG Optimized Renderer åˆå§‹åŒ–å®Œæˆ - é«˜æ€§èƒ½ç‰ˆæœ¬');
    }
    
    /**
     * æ¸²æŸ“æ‰€æœ‰FVG - é«˜æ€§èƒ½ç‰ˆæœ¬
     */
    render(fvgs, timeframe = 'M15') {
        // é˜²æ­¢éå¤šconsoleè¼¸å‡º
        if (fvgs && fvgs.length > 100) {
            console.warn(`âš ï¸ FVGæ•¸é‡éå¤š: ${fvgs.length}ï¼Œé™åˆ¶é¡¯ç¤º`);
            fvgs = fvgs.slice(-50); // åªé¡¯ç¤ºæœ€æ–°50å€‹
        }
        
        console.group('âš¡ FVG Optimized Renderer - é–‹å§‹é«˜æ€§èƒ½æ¸²æŸ“');
        console.log(`ğŸ“Š æ”¶åˆ° ${fvgs ? fvgs.length : 0} å€‹FVG`);
        
        this.clear();
        
        if (!fvgs || fvgs.length === 0) {
            console.log('âš ï¸ æ²’æœ‰FVGæ•¸æ“š');
            console.groupEnd();
            return;
        }
        
        // åˆ†é›¢æœ‰æ•ˆå’Œå·²æ¸…é™¤çš„FVG
        const validFVGs = fvgs.filter(fvg => fvg.status === 'valid');
        const clearedFVGs = fvgs.filter(fvg => fvg.status === 'cleared');
        
        console.log(`ğŸ“ˆ æœ‰æ•ˆFVG: ${validFVGs.length} å€‹`);
        console.log(`ğŸ“‰ å·²æ¸…é™¤FVG: ${clearedFVGs.length} å€‹`);
        
        // é™åˆ¶æ•¸é‡
        const limitedValidFVGs = validFVGs.slice(-this.settings.maxFVGsPerType);
        const limitedClearedFVGs = clearedFVGs.slice(-this.settings.maxFVGsPerType);
        
        // é«˜æ€§èƒ½æ¸²æŸ“æœ‰æ•ˆFVG
        if (this.settings.showFVG) {
            this.renderFVGBoxes(limitedValidFVGs, 'valid', timeframe);
        }
        
        // é«˜æ€§èƒ½æ¸²æŸ“å·²æ¸…é™¤FVG
        if (this.settings.showClearedFVGs) {
            this.renderFVGBoxes(limitedClearedFVGs, 'cleared', timeframe);
        }
        
        console.log(`âœ… é«˜æ€§èƒ½æ¸²æŸ“å®Œæˆ: ${this.priceLines.length} å€‹åƒ¹æ ¼ç·š`);
        console.groupEnd();
    }
    
    /**
     * ä½¿ç”¨LineSeriesçš„FVGæ¸²æŸ“ï¼ˆæœ‰é™é•·åº¦ï¼‰
     */
    renderFVGBoxes(fvgs, status, timeframe) {
        fvgs.forEach((fvg, index) => {
            this.renderSingleFVGOptimized(fvg, index, status, timeframe);
        });
    }
    
    /**
     * æ¸²æŸ“å–®å€‹FVG - ä½¿ç”¨LineSerieså¯¦ç¾æœ‰é™é•·åº¦
     */
    renderSingleFVGOptimized(fvg, index, status, timeframe = 'M15') {
        // æ¸›å°‘consoleè¼¸å‡º
        if (index < 3) { // åªè¼¸å‡ºå‰3å€‹
            console.log(`âš¡ é«˜æ€§èƒ½æ¸²æŸ“FVG[${index}]: type=${fvg.type}, status=${status}`);
        }
        
        try {
            // ç¢ºå®šåƒ¹æ ¼ç¯„åœ
            let topPrice, bottomPrice;
            if (fvg.topPrice !== undefined && fvg.bottomPrice !== undefined) {
                topPrice = fvg.topPrice;
                bottomPrice = fvg.bottomPrice;
            } else if (fvg.startPrice !== undefined && fvg.endPrice !== undefined) {
                if (fvg.type === 'bullish') {
                    topPrice = fvg.endPrice;
                    bottomPrice = fvg.startPrice;
                } else {
                    topPrice = fvg.startPrice;
                    bottomPrice = fvg.endPrice;
                }
            } else {
                console.error('âŒ ç„¡æ³•ç¢ºå®šåƒ¹æ ¼ç¯„åœ');
                return;
            }
            
            // é¡è‰²é…ç½®
            const isCleared = status === 'cleared';
            let color;
            
            if (fvg.type === 'bullish') {
                color = isCleared 
                    ? { bg: 'rgba(128, 128, 128, 0.08)', border: 'rgba(128, 128, 128, 0.4)' }
                    : { bg: 'rgba(0, 214, 143, 0.15)', border: 'rgba(0, 214, 143, 0.5)' };
            } else {
                color = isCleared
                    ? { bg: 'rgba(128, 128, 128, 0.08)', border: 'rgba(128, 128, 128, 0.4)' }
                    : { bg: 'rgba(255, 61, 113, 0.15)', border: 'rgba(255, 61, 113, 0.5)' };
            }
            
            const lineStyle = isCleared 
                ? LightweightCharts.LineStyle.Dashed 
                : LightweightCharts.LineStyle.Solid;
            
            // æ¸›å°‘è¼¸å‡º
            // console.log(`   åƒ¹æ ¼: ${bottomPrice} ~ ${topPrice}`);
            // console.log(`   é¡è‰²: ${color.border}`);
            
            // è¨ˆç®—çµæŸæ™‚é–“ï¼ˆèµ·å§‹æ™‚é–“ + 40æ ¹Kç·šï¼‰
            let startTime = fvg.startTime || fvg.formationTime;
            let endTime = fvg.endTime;
            
            // é©—è­‰æ™‚é–“æˆ³æ ¼å¼
            if (!startTime || startTime < 1000000000) {
                console.error(`âŒ FVGæ™‚é–“æˆ³æ ¼å¼éŒ¯èª¤: ${startTime}`);
                return; // è·³éé€™å€‹FVG
            }
            
            // å¦‚æœæ²’æœ‰endTimeï¼Œè¨ˆç®—40æ ¹Kç·šçš„é•·åº¦
            if (!endTime) {
                // æ ¹æ“šæ™‚é–“æ¡†æ¶è¨ˆç®—
                const timeframeMinutes = {
                    'M1': 1,
                    'M5': 5,
                    'M15': 15,
                    'M30': 30,
                    'H1': 60,
                    'H4': 240,
                    'D1': 1440
                }[timeframe] || 15;
                endTime = startTime + (40 * timeframeMinutes * 60); // 40æ ¹Kç·šçš„ç§’æ•¸
            }
            
            // å‰µå»ºé ‚éƒ¨ç·šç³»åˆ—
            const topLineSeries = this.chart.addSeries(LightweightCharts.LineSeries, {
                color: color.border,
                lineWidth: 1,
                crosshairMarkerVisible: false,
            });
            
            // è¨­å®šé ‚éƒ¨ç·šæ•¸æ“šï¼ˆæœ‰é™é•·åº¦ï¼‰
            topLineSeries.setData([
                { time: startTime, value: topPrice },
                { time: endTime, value: topPrice }
            ]);
            
            // å‰µå»ºåº•éƒ¨ç·šç³»åˆ—
            const bottomLineSeries = this.chart.addSeries(LightweightCharts.LineSeries, {
                color: color.border,
                lineWidth: 1,
                crosshairMarkerVisible: false,
                lastValueVisible: false,
            });
            
            // è¨­å®šåº•éƒ¨ç·šæ•¸æ“šï¼ˆæœ‰é™é•·åº¦ï¼‰
            bottomLineSeries.setData([
                { time: startTime, value: bottomPrice },
                { time: endTime, value: bottomPrice }
            ]);
            
            // å„²å­˜LineSeriesçš„å¼•ç”¨ä»¥ä¾¿æ¸…é™¤
            this.priceLines.push(topLineSeries, bottomLineSeries);
            
            if (index < 3) {
                console.log(`   âš¡ FVG[${index}] æ¸²æŸ“æˆåŠŸ`);
            }
            
        } catch (error) {
            if (index < 5) { // åªè¼¸å‡ºå‰5å€‹éŒ¯èª¤
                console.error(`âŒ FVG[${index}] æ¸²æŸ“å¤±æ•—:`, error);
            }
        }
    }
    
    /**
     * æ¸…é™¤æ‰€æœ‰FVGåœ–å½¢ - é«˜æ€§èƒ½ç‰ˆæœ¬
     */
    clear() {
        console.log(`ğŸ—‘ï¸ æ¸…é™¤ ${this.priceLines.length} å€‹åƒ¹æ ¼ç·š`);
        
        this.priceLines.forEach(series => {
            try {
                // å˜—è©¦ç§»é™¤LineSeries
                if (this.chart.removeSeries) {
                    this.chart.removeSeries(series);
                } else {
                    // å¦‚æœæ˜¯priceLineï¼Œä½¿ç”¨èˆŠæ–¹æ³•
                    this.candlestickSeries.removePriceLine(series);
                }
            } catch (e) {
                // å¿½ç•¥éŒ¯èª¤
            }
        });
        
        this.priceLines = [];
        
        // æ¸…é™¤æ¨™è¨˜
        if (this.markers.length > 0) {
            this.candlestickSeries.setMarkers([]);
            this.markers = [];
        }
    }
    
    /**
     * å…¼å®¹æ€§æ–¹æ³•
     */
    clearAll() {
        this.clear();
    }
    
    toggle() {
        this.settings.showFVG = !this.settings.showFVG;
        console.log(`ğŸ”„ FVGé¡¯ç¤ºç‹€æ…‹åˆ‡æ›ç‚º: ${this.settings.showFVG}`);
    }
    
    setVisible(visible) {
        this.settings.showFVG = visible;
        console.log(`ğŸ‘ï¸ FVGå¯è¦‹æ€§è¨­ç½®ç‚º: ${visible}`);
    }
    
    toggleMarkers() {
        this.settings.showFVGMarkers = !this.settings.showFVGMarkers;
        console.log(`ğŸ·ï¸ FVGæ¨™è¨˜é¡¯ç¤ºç‹€æ…‹åˆ‡æ›ç‚º: ${this.settings.showFVGMarkers}`);
    }
    
    toggleClearedFVGs() {
        this.settings.showClearedFVGs = !this.settings.showClearedFVGs;
        console.log(`ğŸ“‰ å·²æ¸…é™¤FVGé¡¯ç¤ºç‹€æ…‹åˆ‡æ›ç‚º: ${this.settings.showClearedFVGs}`);
    }
    
    getStats() {
        return {
            totalFVGs: this.priceLines.length / 2, // æ¯å€‹FVGæœ‰2æ¢ç·š
            showFVG: this.settings.showFVG,
            showFVGMarkers: this.settings.showFVGMarkers,
            showClearedFVGs: this.settings.showClearedFVGs,
            renderMethod: 'createPriceLine (é«˜æ€§èƒ½)'
        };
    }
    
    updateSettings(settings) {
        Object.assign(this.settings, settings);
        console.log('âš™ï¸ FVGè¨­ç½®å·²æ›´æ–°:', this.settings);
    }
}

// å°å‡ºçµ¦å…¨åŸŸä½¿ç”¨
if (typeof window !== 'undefined') {
    window.FVGRendererOptimized = FVGRendererOptimized;
}