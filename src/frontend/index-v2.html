<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易圖表系統 - 紐約開盤前分析</title>
    <link rel="stylesheet" href="style-v2.css">
</head>
<body>
    <!-- 主要佈局容器 -->
    <div class="main-layout">
        <!-- 左側固定技術指標面板 -->
        <div id="indicators-panel" class="indicators-panel">
            <!-- 面板控制區 -->
            <div class="panel-control">
                <button id="panel-toggle" class="panel-toggle" title="收合/展開">☰</button>
                <span class="panel-title">技術指標</span>
            </div>
            
            <!-- 指標內容區 -->
            <div class="indicators-content">
                <!-- 價格動作指標 -->
                <div class="indicator-category expanded" data-category="price-action">
                    <div class="indicator-category-header">
                        <span>價格動作</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="fvg-checkbox" checked>
                            <span class="indicator-name">Fair Value Gap (FVG)</span>
                            <button class="settings-btn" data-indicator="fvg" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="sr-checkbox">
                            <span class="indicator-name">支撐阻力位</span>
                            <button class="settings-btn" data-indicator="sr" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="pivot-checkbox">
                            <span class="indicator-name">樞紐點</span>
                            <button class="settings-btn" data-indicator="pivot" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
                
                <!-- 移動平均線 -->
                <div class="indicator-category" data-category="moving-averages">
                    <div class="indicator-category-header">
                        <span>移動平均線</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="sma-checkbox">
                            <span class="indicator-name">簡單移動平均 (SMA)</span>
                            <button class="settings-btn" data-indicator="sma" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="ema-checkbox">
                            <span class="indicator-name">指數移動平均 (EMA)</span>
                            <button class="settings-btn" data-indicator="ema" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="bb-checkbox">
                            <span class="indicator-name">布林通道 (BB)</span>
                            <button class="settings-btn" data-indicator="bb" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
                
                <!-- 震盪指標 -->
                <div class="indicator-category" data-category="oscillators">
                    <div class="indicator-category-header">
                        <span>震盪指標</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="rsi-checkbox">
                            <span class="indicator-name">相對強弱指數 (RSI)</span>
                            <button class="settings-btn" data-indicator="rsi" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="macd-checkbox">
                            <span class="indicator-name">MACD</span>
                            <button class="settings-btn" data-indicator="macd" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="stoch-checkbox">
                            <span class="indicator-name">隨機指標 (Stochastic)</span>
                            <button class="settings-btn" data-indicator="stoch" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
                
                <!-- 成交量指標 -->
                <div class="indicator-category" data-category="volume">
                    <div class="indicator-category-header">
                        <span>成交量指標</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="volume-checkbox">
                            <span class="indicator-name">成交量</span>
                            <button class="settings-btn" data-indicator="volume" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="vwap-checkbox">
                            <span class="indicator-name">成交量加權平均價 (VWAP)</span>
                            <button class="settings-btn" data-indicator="vwap" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="obv-checkbox">
                            <span class="indicator-name">能量潮 (OBV)</span>
                            <button class="settings-btn" data-indicator="obv" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右側主內容區 -->
        <div class="main-content">
            <div class="container">
                <!-- 頂部控制面板 -->
                <div class="control-panel">
                    <div class="info-section">
                        <h1>交易圖表系統</h1>
                        <div class="date-info">
                            <span id="current-date">載入中...</span>
                            <span id="market-info">載入中...</span>
                            <span id="holiday-info" class="holiday-badge" style="display: none;">美國假日</span>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <!-- 操作按鈕 -->
                        <div class="action-buttons">
                            <button id="refresh-btn" class="btn btn-primary">隨機日期</button>
                            <button id="reset-zoom-btn" class="btn btn-secondary">重置縮放</button>
                            <button id="fvg-toggle-btn" class="btn btn-toggle active">FVG 開</button>
                            <button id="draw-line-btn" class="btn btn-tool">畫線</button>
                            <button id="clear-lines-btn" class="btn btn-danger">清除線</button>
                        </div>
                    </div>
                </div>
                
                <!-- 時間刻度分頁 -->
                <div class="timeframe-tabs">
                    <button class="tab-btn" data-timeframe="M1">M1</button>
                    <button class="tab-btn" data-timeframe="M5">M5</button>
                    <button class="tab-btn active" data-timeframe="M15">M15</button>
                    <button class="tab-btn" data-timeframe="H1">H1</button>
                    <button class="tab-btn" data-timeframe="H4">H4</button>
                    <button class="tab-btn" data-timeframe="D1">D1</button>
                </div>
                
                <!-- 播放控制面板 -->
                <div class="playback-panel">
                    <div class="playback-controls">
                        <button id="play-btn" class="btn btn-play">開始</button>
                        <button id="pause-btn" class="btn btn-pause" disabled>暫停</button>
                        
                        <div class="speed-selector">
                            <label>播放速度：</label>
                            <select id="speed-select">
                                <option value="1">1秒/根</option>
                                <option value="2">2秒/根</option>
                                <option value="5" selected>5秒/根</option>
                                <option value="10">10秒/根</option>
                                <option value="20">20秒/根</option>
                                <option value="30">30秒/根</option>
                            </select>
                        </div>
                        
                        <div class="playback-info">
                            <span id="playback-time">播放時間: --</span>
                            <span id="countdown">下一根: --</span>
                        </div>
                    </div>
                </div>
                
                <!-- 圖表容器 -->
                <div class="chart-container">
                    <div id="chart"></div>
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>正在載入圖表資料...</p>
                    </div>
                    <!-- 後端載入進度顯示 (暫時隱藏) -->
                    <div id="backend-loading" class="backend-loading" style="display: none !important;">
                        <div class="backend-loading-content">
                            <h3>系統啟動中...</h3>
                            <div class="progress-container">
                                <div id="progress-bar" class="progress-bar"></div>
                            </div>
                            <div class="progress-info">
                                <span id="progress-text">檢查系統狀態...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div id="progress-steps" class="progress-steps">
                                <div class="step">正在載入資料...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 狀態列 -->
                <div class="status-bar">
                    <div class="status-info">
                        <span id="candle-count">K線數量: --</span>
                        <span id="fvg-count">FVG數量: --</span>
                        <span id="time-range">時間範圍: --</span>
                        <span id="dst-status">時區狀態: --</span>
                    </div>
                    <div class="hover-info">
                        <span id="hover-data">將滑鼠移至圖表查看詳細資料</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 引入 Lightweight Charts - 使用多個備用 CDN -->
    <script>
        // 檢查並載入 Lightweight Charts
        function loadLightweightCharts() {
            return new Promise((resolve, reject) => {
                const cdnList = [
                    'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.1.3/lightweight-charts.standalone.production.min.js'
                ];
                
                let currentIndex = 0;
                
                function tryLoad() {
                    if (currentIndex >= cdnList.length) {
                        reject(new Error('所有 CDN 都無法載入 Lightweight Charts'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    
                    script.onload = () => {
                        console.log('Lightweight Charts 載入成功:', cdnList[currentIndex]);
                        // 檢查 API 是否可用
                        if (typeof LightweightCharts !== 'undefined' && 
                            typeof LightweightCharts.createChart === 'function') {
                            resolve();
                        } else {
                            console.warn('Lightweight Charts API 不完整');
                            currentIndex++;
                            tryLoad();
                        }
                    };
                    
                    script.onerror = () => {
                        console.warn('CDN 載入失敗:', cdnList[currentIndex]);
                        currentIndex++;
                        tryLoad();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoad();
            });
        }
        
        // 載入多個腳本的輔助函數
        function loadModules(modules, callback) {
            console.log(`開始載入 ${modules.length} 個模組`);
            let loaded = 0;
            
            if (modules.length === 0) {
                console.log('沒有模組需要載入');
                callback();
                return;
            }
            
            modules.forEach(module => {
                console.log(`正在載入模組: ${module}`);
                const script = document.createElement('script');
                script.src = module;
                script.onload = () => {
                    loaded++;
                    console.log(`模組載入成功 (${loaded}/${modules.length}): ${module}`);
                    if (loaded === modules.length) {
                        console.log('所有模組載入完成，執行回調');
                        callback();
                    }
                };
                script.onerror = (error) => {
                    console.error(`模組載入失敗: ${module}`, error);
                    alert(`系統模組載入失敗: ${module}`);
                };
                document.head.appendChild(script);
            });
        }

        // 載入完成後初始化
        loadLightweightCharts()
            .then(() => {
                console.log('開始載入主程式...');
                // 先載入聚合器
                const aggregatorScript = document.createElement('script');
                aggregatorScript.src = 'candleAggregator.js';
                
                aggregatorScript.onload = () => {
                    console.log('CandleAggregator 載入成功');
                    console.log('開始載入其他模組...');
                    
                    // 載入配置和管理器模組
                    const modules = ['config.js', 'fvg-renderer.js', 'chart-manager.js', 'data-manager.js', 'playback-manager.js', 'event-manager.js'];
                    console.log('要載入的模組:', modules);
                    
                    loadModules(modules, () => {
                        console.log('所有模組載入完成，開始載入主程式 script-v2.js');
                        // 最後載入主程式 - 使用新的 script-v2.js
                        const script = document.createElement('script');
                        script.src = 'script-v2.js';
                        script.onload = () => {
                            console.log('script-v2.js 載入成功');
                        };
                        script.onerror = (error) => {
                            console.error('script-v2.js 載入失敗:', error);
                        };
                        document.head.appendChild(script);
                    });
                };
                
                aggregatorScript.onerror = () => {
                    console.error('CandleAggregator 載入失敗');
                    alert('系統載入失敗，請重新整理頁面。');
                };
                
                document.head.appendChild(aggregatorScript);
            })
            .catch(error => {
                console.error('圖表庫載入失敗:', error);
                alert('圖表庫載入失敗，請檢查網路連線或嘗試重新整理頁面。');
            });
    </script>
</body>
</html>