<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“åœ–è¡¨ç³»çµ± - ç´ç´„é–‹ç›¤å‰åˆ†æ</title>
    
    <!-- æ€§èƒ½å„ªåŒ–ï¼šé è¼‰å…¥é—œéµè³‡æº -->
    <link rel="preload" href="config.js" as="script">
    <link rel="preload" href="chart-manager.js" as="script">
    <link rel="preload" href="data-manager.js" as="script">
    <link rel="preload" href="fvg-renderer-optimized.js" as="script">
    <link rel="prefetch" href="playback-manager.js" as="script">
    <link rel="prefetch" href="event-manager.js" as="script">
    
    <link rel="stylesheet" href="style-v2.css">
    
    <!-- æ™ºèƒ½è¼‰å…¥æ¨¡å¼åˆ‡æ›å™¨æ¨£å¼ -->
    <style>
        .mode-switcher {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .mode-switcher button {
            margin: 0 2px;
            padding: 4px 8px;
            font-size: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mode-switcher button:hover {
            background: #555;
        }
        
        .mode-switcher button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .mode-info {
            margin-top: 4px;
            font-size: 10px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- æ™ºèƒ½è¼‰å…¥æ¨¡å¼åˆ‡æ›å™¨ -->
    <div class="mode-switcher">
        <div>è¼‰å…¥æ¨¡å¼:</div>
        <button onclick="switchLoadingMode('production')" id="mode-production">ç”Ÿç”¢</button>
        <button onclick="switchLoadingMode('debug')" id="mode-debug">èª¿è©¦</button>
        <button onclick="switchLoadingMode('development')" id="mode-development">é–‹ç™¼</button>
        <div class="mode-info">
            <span>ç•¶å‰: </span><span id="current-mode">auto</span>
        </div>
    </div>

    <!-- è¼‰å…¥é€²åº¦è¦†è“‹å±¤ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loading-header">
                <h2>äº¤æ˜“åœ–è¡¨ç³»çµ±è¼‰å…¥ä¸­</h2>
                <div class="loading-subtitle">æ­£åœ¨åˆå§‹åŒ–æ•¸æ“šå’ŒåŠŸèƒ½æ¨¡çµ„...</div>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div id="progress-text" class="progress-text">0%</div>
                </div>
                
                <div id="current-step" class="current-step">æº–å‚™è¼‰å…¥è³‡æ–™...</div>
                <div id="current-file" class="current-file"></div>
                
                <div class="details-section">
                    <div id="time-info" class="time-info">
                        <span id="elapsed-time">å·²ç”¨æ™‚é–“: 0s</span>
                        <span id="estimated-time">é ä¼°å‰©é¤˜: --</span>
                    </div>
                    <div id="loading-details" class="loading-details"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦ä½ˆå±€å®¹å™¨ -->
    <div class="main-layout">
        <!-- å·¦å´å›ºå®šæŠ€è¡“æŒ‡æ¨™é¢æ¿ -->
        <div id="indicators-panel" class="indicators-panel">
            <!-- é¢æ¿æ§åˆ¶å€ -->
            <div class="panel-control">
                <button id="panel-toggle" class="panel-toggle" title="æ”¶åˆ/å±•é–‹">â˜°</button>
                <span class="panel-title">æŠ€è¡“æŒ‡æ¨™</span>
            </div>
            
            <!-- æŒ‡æ¨™å…§å®¹å€ -->
            <div class="indicators-content">
                <!-- åƒ¹æ ¼å‹•ä½œæŒ‡æ¨™ -->
                <div class="indicator-category expanded" data-category="price-action">
                    <div class="indicator-category-header">
                        <span>åƒ¹æ ¼å‹•ä½œ</span>
                        <span class="category-arrow">â–¶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="fvg-checkbox" checked>
                            <span class="indicator-name">Fair Value Gap (FVG)</span>
                            <button class="settings-btn" data-indicator="fvg" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <!-- FVG å­è¨­å®šé …ç›® -->
                        <div class="sub-indicator-list" id="fvg-sub-controls">
                            <label class="sub-indicator-item">
                                <input type="checkbox" id="fvg-markers-checkbox">
                                <span class="sub-indicator-name">FVGæ¨™è¨˜ (F1, F2...)</span>
                            </label>
                            
                            <label class="sub-indicator-item">
                                <input type="checkbox" id="fvg-cleared-checkbox">
                                <span class="sub-indicator-name">é¡¯ç¤ºå·²æ¸…é™¤FVG</span>
                            </label>
                            
                            <div class="sub-indicator-item">
                                <label for="fvg-performance-mode" class="sub-indicator-name">æ€§èƒ½æ¨¡å¼:</label>
                                <select id="fvg-performance-mode" class="performance-select">
                                    <option value="high">é«˜è³ªé‡ (130ç·š)</option>
                                    <option value="balanced">å¹³è¡¡ (60ç·š)</option>
                                    <option value="performance">æ€§èƒ½å„ªå…ˆ (20ç·š)</option>
                                </select>
                            </div>
                            
                            <div class="fvg-stats" id="fvg-stats">
                                <div class="stats-item">
                                    <span>æ¸²æŸ“åœ–å…ƒ:</span>
                                    <span id="fvg-primitives-count">-</span>
                                </div>
                                <div class="stats-item">
                                    <span>æ¨™è¨˜æ•¸é‡:</span>
                                    <span id="fvg-markers-count">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="sr-checkbox">
                            <span class="indicator-name">æ”¯æ’é˜»åŠ›ä½</span>
                            <button class="settings-btn" data-indicator="sr" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="pivot-checkbox">
                            <span class="indicator-name">æ¨ç´é»</span>
                            <button class="settings-btn" data-indicator="pivot" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                    </div>
                </div>
                
                <!-- ç§»å‹•å¹³å‡ç·š -->
                <div class="indicator-category" data-category="moving-averages">
                    <div class="indicator-category-header">
                        <span>ç§»å‹•å¹³å‡ç·š</span>
                        <span class="category-arrow">â–¶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="sma-checkbox">
                            <span class="indicator-name">ç°¡å–®ç§»å‹•å¹³å‡ (SMA)</span>
                            <button class="settings-btn" data-indicator="sma" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="ema-checkbox">
                            <span class="indicator-name">æŒ‡æ•¸ç§»å‹•å¹³å‡ (EMA)</span>
                            <button class="settings-btn" data-indicator="ema" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="bb-checkbox">
                            <span class="indicator-name">å¸ƒæ—é€šé“ (BB)</span>
                            <button class="settings-btn" data-indicator="bb" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                    </div>
                </div>
                
                <!-- éœ‡ç›ªæŒ‡æ¨™ -->
                <div class="indicator-category" data-category="oscillators">
                    <div class="indicator-category-header">
                        <span>éœ‡ç›ªæŒ‡æ¨™</span>
                        <span class="category-arrow">â–¶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="rsi-checkbox">
                            <span class="indicator-name">ç›¸å°å¼·å¼±æŒ‡æ•¸ (RSI)</span>
                            <button class="settings-btn" data-indicator="rsi" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="macd-checkbox">
                            <span class="indicator-name">MACD</span>
                            <button class="settings-btn" data-indicator="macd" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="stoch-checkbox">
                            <span class="indicator-name">éš¨æ©ŸæŒ‡æ¨™ (Stochastic)</span>
                            <button class="settings-btn" data-indicator="stoch" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                    </div>
                </div>
                
                <!-- æˆäº¤é‡æŒ‡æ¨™ -->
                <div class="indicator-category" data-category="volume">
                    <div class="indicator-category-header">
                        <span>æˆäº¤é‡æŒ‡æ¨™</span>
                        <span class="category-arrow">â–¶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="volume-checkbox">
                            <span class="indicator-name">æˆäº¤é‡</span>
                            <button class="settings-btn" data-indicator="volume" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="vwap-checkbox">
                            <span class="indicator-name">æˆäº¤é‡åŠ æ¬Šå¹³å‡åƒ¹ (VWAP)</span>
                            <button class="settings-btn" data-indicator="vwap" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="obv-checkbox">
                            <span class="indicator-name">èƒ½é‡æ½® (OBV)</span>
                            <button class="settings-btn" data-indicator="obv" title="è¨­å®šåƒæ•¸">âš™</button>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³å´ä¸»å…§å®¹å€ -->
        <div class="main-content">
            <div class="container">
                <!-- é ‚éƒ¨æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <div class="info-section">
                        <h1>äº¤æ˜“åœ–è¡¨ç³»çµ±</h1>
                        <div class="date-info">
                            <span id="current-date">è¼‰å…¥ä¸­...</span>
                            <span id="market-info">è¼‰å…¥ä¸­...</span>
                            <span id="holiday-info" class="holiday-badge" style="display: none;">ç¾åœ‹å‡æ—¥</span>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="action-buttons">
                            <button id="refresh-btn" class="btn btn-primary">éš¨æ©Ÿæ—¥æœŸ</button>
                            <button id="reset-zoom-btn" class="btn btn-secondary">é‡ç½®ç¸®æ”¾</button>
                            <button id="test-scaling-btn" class="btn btn-warning">æ¸¬è©¦ç¸®æ”¾</button>
                            <button id="draw-line-btn" class="btn btn-tool">ç•«ç·š</button>
                            <button id="clear-lines-btn" class="btn btn-danger">æ¸…é™¤ç·š</button>
                        </div>
                    </div>
                </div>
                
                <!-- æ™‚é–“åˆ»åº¦åˆ†é  -->
                <div class="timeframe-tabs">
                    <button class="tab-btn" data-timeframe="M1">M1</button>
                    <button class="tab-btn" data-timeframe="M5">M5</button>
                    <button class="tab-btn active" data-timeframe="M15">M15</button>
                    <button class="tab-btn" data-timeframe="H1">H1</button>
                    <button class="tab-btn" data-timeframe="H4">H4</button>
                    <button class="tab-btn" data-timeframe="D1">D1</button>
                </div>
                
                <!-- æ’­æ”¾æ§åˆ¶é¢æ¿ -->
                <div class="playback-panel">
                    <div class="playback-controls">
                        <button id="play-btn" class="btn btn-play">é–‹å§‹</button>
                        <button id="pause-btn" class="btn btn-pause" disabled>æš«åœ</button>
                        
                        <div class="speed-selector">
                            <label>æ’­æ”¾é€Ÿåº¦ï¼š</label>
                            <select id="speed-select">
                                <option value="1">1ç§’/æ ¹</option>
                                <option value="2">2ç§’/æ ¹</option>
                                <option value="5" selected>5ç§’/æ ¹</option>
                                <option value="10">10ç§’/æ ¹</option>
                                <option value="20">20ç§’/æ ¹</option>
                                <option value="30">30ç§’/æ ¹</option>
                            </select>
                        </div>
                        
                        <div class="playback-info">
                            <span id="playback-time">æ’­æ”¾æ™‚é–“: --</span>
                            <span id="countdown">ä¸‹ä¸€æ ¹: --</span>
                        </div>
                    </div>
                </div>
                
                <!-- åœ–è¡¨å®¹å™¨ -->
                <div class="chart-container">
                    <div id="chart"></div>
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨è¼‰å…¥åœ–è¡¨è³‡æ–™...</p>
                    </div>
                    
                    <!-- v5è¼‰å…¥é€²åº¦é¡¯ç¤º -->
                    <div id="v5-loading" class="backend-loading" style="display: block;">
                        <div class="backend-loading-content">
                            <h3>Lightweight Charts v5 ç³»çµ±å•Ÿå‹•ä¸­...</h3>
                            <div class="progress-container">
                                <div id="v5-progress-bar" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span id="v5-progress-text">æ­£åœ¨æª¢æ¸¬ç‰ˆæœ¬...</span>
                                <span id="v5-progress-percent">0%</span>
                            </div>
                            <div id="v5-progress-steps" class="progress-steps">
                                <div class="step">æº–å‚™è¼‰å…¥ Lightweight Charts...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç‰ˆæœ¬é¡¯ç¤º -->
                    <div style="position: absolute; top: 10px; right: 10px; color: #666; font-size: 12px;" id="version-info">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                
                <!-- ç‹€æ…‹åˆ— -->
                <div class="status-bar">
                    <div class="status-info">
                        <span id="candle-count">Kç·šæ•¸é‡: --</span>
                        <span id="fvg-count">FVGæ•¸é‡: --</span>
                        <span id="time-range">æ™‚é–“ç¯„åœ: --</span>
                        <span id="dst-status">æ™‚å€ç‹€æ…‹: --</span>
                        <span id="chart-version">åœ–è¡¨ç‰ˆæœ¬: --</span>
                    </div>
                    <div class="hover-info">
                        <span id="hover-data">å°‡æ»‘é¼ ç§»è‡³åœ–è¡¨æŸ¥çœ‹è©³ç´°è³‡æ–™</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¼•å…¥ Lightweight Charts v5.0.0 -->
    <script>
        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percent, text, step) {
            // æ›´æ–°æ–°çš„è¼‰å…¥é€²åº¦æ¢å…ƒç´ 
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const currentStep = document.getElementById('current-step');
            const currentFile = document.getElementById('current-file');
            const loadingDetails = document.getElementById('loading-details');
            
            if (progressFill) progressFill.style.width = percent + '%';
            if (progressText) progressText.textContent = Math.round(percent) + '%';
            if (currentStep) currentStep.textContent = text;
            
            if (step && currentFile) {
                currentFile.textContent = step;
            }
            
            // æ›´æ–°è¼‰å…¥è©³æƒ…
            if (step && loadingDetails) {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-info';
                stepDiv.textContent = `â–º ${new Date().toLocaleTimeString()}: ${step}`;
                loadingDetails.appendChild(stepDiv);
                
                // ä¿æŒæœ€æ–°çš„5å€‹æ­¥é©Ÿ
                while (loadingDetails.children.length > 5) {
                    loadingDetails.removeChild(loadingDetails.firstChild);
                }
                loadingDetails.scrollTop = loadingDetails.scrollHeight;
            }
            
            // èˆŠçš„é€²åº¦æ¢ç›¸å®¹æ€§ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldProgressBar = document.getElementById('v5-progress-bar');
            const oldProgressText = document.getElementById('v5-progress-text');
            const oldProgressPercent = document.getElementById('v5-progress-percent');
            const oldProgressSteps = document.getElementById('v5-progress-steps');
            
            if (oldProgressBar) oldProgressBar.style.width = percent + '%';
            if (oldProgressText) oldProgressText.textContent = text;
            if (oldProgressPercent) oldProgressPercent.textContent = percent + '%';
            if (step && oldProgressSteps) {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.textContent = `[${new Date().toLocaleTimeString()}] ${step}`;
                oldProgressSteps.appendChild(stepDiv);
                oldProgressSteps.scrollTop = oldProgressSteps.scrollHeight;
            }
        }
        
        // å¾Œç«¯è¼‰å…¥ç‹€æ…‹ç›£æ§
        function startBackendLoadingMonitor() {
            const elapsedTimeEl = document.getElementById('elapsed-time');
            const estimatedTimeEl = document.getElementById('estimated-time');
            const currentFileEl = document.getElementById('current-file');
            
            let startTime = Date.now();
            let hasShownBackendComplete = false;
            
            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡ï¼Œä»¥é˜²å¾Œç«¯å·²ç¶“è¼‰å…¥å®Œæˆ
            checkBackendStatus();
            
            const monitor = setInterval(checkBackendStatus, 1000);
            
            async function checkBackendStatus() {
                try {
                    const response = await fetch('http://127.0.0.1:5001/api/loading-status');
                    if (response.ok) {
                        const status = await response.json();
                        
                        // æ›´æ–°ç¶“éæ™‚é–“
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        if (elapsedTimeEl) elapsedTimeEl.textContent = `å·²ç”¨æ™‚é–“: ${elapsed}s`;
                        
                        // æ›´æ–°é ä¼°æ™‚é–“
                        if (status.estimated_time_remaining && estimatedTimeEl) {
                            estimatedTimeEl.textContent = `é ä¼°å‰©é¤˜: ${status.estimated_time_remaining}s`;
                        } else if (estimatedTimeEl) {
                            estimatedTimeEl.textContent = `é ä¼°å‰©é¤˜: --`;
                        }
                        
                        // æ›´æ–°ç•¶å‰æª”æ¡ˆ
                        if (status.current_file && currentFileEl) {
                            currentFileEl.textContent = `æ­£åœ¨è™•ç†: ${status.current_file}`;
                        }
                        
                        // æ›´æ–°é€²åº¦
                        if (status.progress !== undefined) {
                            updateProgress(status.progress, status.current_step || 'è¼‰å…¥ä¸­...', status.current_file || '');
                        }
                        
                        // å¦‚æœå¾Œç«¯è¼‰å…¥å·²å®Œæˆ
                        if (!status.is_loading && !hasShownBackendComplete) {
                            hasShownBackendComplete = true;
                            updateProgress(100, 'å¾Œç«¯è¼‰å…¥å®Œæˆï¼Œé–‹å§‹å‰ç«¯åˆå§‹åŒ–...', 'æº–å‚™è¼‰å…¥å‰ç«¯æ¨¡çµ„');
                            
                            // ç¹¼çºŒå‰ç«¯è¼‰å…¥æµç¨‹ï¼Œä¸ç«‹å³éš±è—è¼‰å…¥è¦†è“‹å±¤
                            console.log('å¾Œç«¯è¼‰å…¥å®Œæˆï¼Œé–‹å§‹å‰ç«¯è¼‰å…¥æµç¨‹');
                            // ä¸è¦æ¸…é™¤ monitorï¼Œè®“å‰ç«¯æµç¨‹æ§åˆ¶è¼‰å…¥è¦†è“‹å±¤çš„éš±è—
                        }
                        
                        // åªæœ‰åœ¨å‰ç«¯ä¹Ÿå®Œæˆå¾Œæ‰éš±è—è¼‰å…¥è¦†è“‹å±¤
                        // é€™å€‹é‚è¼¯å°‡åœ¨å‰ç«¯è¼‰å…¥å®Œæˆæ™‚è™•ç†
                        
                    } else {
                        console.warn('ç„¡æ³•ç²å–è¼‰å…¥ç‹€æ…‹');
                        // å¦‚æœç„¡æ³•ç²å–ç‹€æ…‹ï¼Œå‡è¨­è¼‰å…¥å®Œæˆä¸¦ç¹¼çºŒå‰ç«¯æµç¨‹
                        if (!hasShownBackendComplete) {
                            hasShownBackendComplete = true;
                            updateProgress(50, 'å¾Œç«¯é€£æ¥ç•°å¸¸ï¼Œç¹¼çºŒå‰ç«¯è¼‰å…¥...', 'æº–å‚™è¼‰å…¥å‰ç«¯æ¨¡çµ„');
                        }
                    }
                } catch (error) {
                    console.log('å¾Œç«¯è¼‰å…¥ç‹€æ…‹ç›£æ§éŒ¯èª¤:', error);
                    // å¦‚æœé€£æ¥å¤±æ•—ï¼Œå‡è¨­è¼‰å…¥å®Œæˆä¸¦ç¹¼çºŒå‰ç«¯æµç¨‹
                    if (!hasShownBackendComplete) {
                        hasShownBackendComplete = true;
                        updateProgress(50, 'å¾Œç«¯é€£æ¥å¤±æ•—ï¼Œç¹¼çºŒå‰ç«¯è¼‰å…¥...', 'æº–å‚™è¼‰å…¥å‰ç«¯æ¨¡çµ„');
                    }
                }
            }
            
            // è¿”å›ç›£æ§æ§åˆ¶å™¨ï¼Œè®“å‰ç«¯è¼‰å…¥å®Œæˆæ™‚å¯ä»¥åœæ­¢ç›£æ§
            return {
                stop: () => clearInterval(monitor),
                isBackendComplete: () => hasShownBackendComplete
            };
        }

        // æª¢æŸ¥å¾Œç«¯APIç‹€æ…‹
        async function checkBackendStatus() {
            updateProgress(5, 'æª¢æŸ¥å¾Œç«¯APIç‹€æ…‹...', 'æ­£åœ¨é€£æ¥å¾Œç«¯æœå‹™');
            
            try {
                // å˜—è©¦é€£æ¥å¥åº·æª¢æŸ¥ç«¯é»
                const response = await fetch('http://127.0.0.1:5001/api/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const healthData = await response.json();
                    updateProgress(8, 'å¾Œç«¯APIé€£æ¥æˆåŠŸ', `å¾Œç«¯æœå‹™é‹è¡Œæ­£å¸¸ - ${healthData.service}`);
                    return true;
                } else {
                    updateProgress(8, 'å¾Œç«¯APIéŸ¿æ‡‰ç•°å¸¸', `HTTP ${response.status} - è«‹æª¢æŸ¥å¾Œç«¯ç‹€æ…‹`);
                    return false;
                }
            } catch (error) {
                updateProgress(8, 'å¾Œç«¯APIé€£æ¥å¤±æ•—', 'è­¦å‘Š: ç„¡æ³•é€£æ¥å¾Œç«¯ï¼Œå°‡ç¹¼çºŒå‰ç«¯è¼‰å…¥');
                console.warn('å¾Œç«¯æª¢æŸ¥å¤±æ•—ï¼Œä½†ç¹¼çºŒå‰ç«¯è¼‰å…¥:', error);
                console.log('æç¤º: è«‹ç¢ºèªå¾Œç«¯æœå‹™å·²å•Ÿå‹• (åŸ·è¡Œ: cd src/backend && python app.py)');
                return false; // è¿”å›falseä½†ä¸é˜»æ­¢å‰ç«¯ç¹¼çºŒ
            }
        }

        // æª¢æŸ¥ä¸¦è¼‰å…¥ Lightweight Charts v5
        function loadLightweightCharts() {
            updateProgress(10, 'é–‹å§‹è¼‰å…¥ Lightweight Charts...', 'æª¢æ¸¬CDNå¯ç”¨æ€§');
            
            return new Promise((resolve, reject) => {
                const cdnList = [
                    // ğŸš€ v5å‡ç´šï¼šå„ªå…ˆè¼‰å…¥Lightweight Charts v5
                    'https://unpkg.com/lightweight-charts@5.0.0/dist/lightweight-charts.standalone.production.js',
                    'https://cdn.jsdelivr.net/npm/lightweight-charts@5.0.0/dist/lightweight-charts.standalone.production.js',
                    // v4.1.3ä½œç‚ºå‚™é¸ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
                    'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js'
                ];
                
                let currentIndex = 0;
                
                function tryLoad() {
                    if (currentIndex >= cdnList.length) {
                        reject(new Error('æ‰€æœ‰ CDN éƒ½ç„¡æ³•è¼‰å…¥ Lightweight Charts'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    
                    script.onload = () => {
                        console.log('Lightweight Charts è¼‰å…¥æˆåŠŸ:', cdnList[currentIndex]);
                        updateProgress(30, 'æª¢æ¸¬ç‰ˆæœ¬åŠŸèƒ½...', 'åœ–è¡¨åº«è¼‰å…¥æˆåŠŸ');
                        
                        // æª¢æŸ¥ API æ˜¯å¦å¯ç”¨
                        if (typeof LightweightCharts !== 'undefined' && 
                            typeof LightweightCharts.createChart === 'function') {
                            
                            // æª¢æ¸¬ç‰ˆæœ¬
                            let version = 'v4.x';
                            try {
                                // æª¢æŸ¥v5ç‰¹æœ‰åŠŸèƒ½
                                if (typeof LightweightCharts.version === 'string') {
                                    console.log('LightweightCharts version:', LightweightCharts.version);
                                    if (LightweightCharts.version.startsWith('5.')) {
                                        version = 'v5.x';
                                    }
                                } else {
                                    // æª¢æŸ¥APIå·®ç•°
                                    const testChart = LightweightCharts.createChart(document.createElement('div'), {
                                        width: 100, height: 100
                                    });
                                    
                                    // v5æª¢æ¸¬ï¼šæª¢æŸ¥addCustomSerieså’Œæ–°API
                                    const hasCustomSeries = typeof testChart.addCustomSeries === 'function';
                                    const hasCandlestickSeries = typeof testChart.addCandlestickSeries === 'function';
                                    
                                    console.log('APIæª¢æ¸¬:', { hasCustomSeries, hasCandlestickSeries });
                                    
                                    if (hasCustomSeries) {
                                        version = 'v5.x';
                                    } else if (hasCandlestickSeries) {
                                        version = 'v4.x';
                                    }
                                }
                            } catch (e) {
                                console.warn('ç‰ˆæœ¬æª¢æ¸¬è­¦å‘Š:', e);
                                version = 'v4.x'; // å®‰å…¨å›é€€
                            }
                            
                            console.log('æª¢æ¸¬åˆ° Lightweight Charts ç‰ˆæœ¬:', version);
                            document.getElementById('version-info').textContent = `LWC ${version}`;
                            updateProgress(50, `ç‰ˆæœ¬æª¢æ¸¬å®Œæˆ: ${version}`, `ç¢ºèªä½¿ç”¨ ${version}`);
                            
                            resolve(version);
                        } else {
                            console.warn('Lightweight Charts API ä¸å®Œæ•´');
                            currentIndex++;
                            tryLoad();
                        }
                    };
                    
                    script.onerror = () => {
                        console.warn('CDN è¼‰å…¥å¤±æ•—:', cdnList[currentIndex]);
                        currentIndex++;
                        tryLoad();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoad();
            });
        }
        
        // è¼‰å…¥å¤šå€‹è…³æœ¬çš„è¼”åŠ©å‡½æ•¸
        // èˆŠçš„ loadModules å‡½æ•¸å·²è¢«å„ªåŒ–çš„ä¸¦è¡Œè¼‰å…¥ç³»çµ±å–ä»£

        // ä¸»è¦å•Ÿå‹•æµç¨‹
        async function startSystem() {
            try {
                // 1. æª¢æŸ¥å¾Œç«¯ç‹€æ…‹
                const backendOk = await checkBackendStatus();
                if (!backendOk) {
                    updateProgress(8, 'å¾Œç«¯æœå‹™ä¸å¯ç”¨', 'è­¦å‘Š: å¾Œç«¯å¯èƒ½éœ€è¦é‡æ–°å•Ÿå‹•');
                    // ç¹¼çºŒè¼‰å…¥å‰ç«¯ï¼Œä½†æé†’ç”¨æˆ¶
                }
                
                // 2. è¼‰å…¥åœ–è¡¨åº«
                const version = await loadLightweightCharts();
                console.log('é–‹å§‹è¼‰å…¥ä¸»ç¨‹å¼... ç‰ˆæœ¬:', version);
                
                return version;
            } catch (error) {
                console.error('ç³»çµ±å•Ÿå‹•å¤±æ•—:', error);
                updateProgress(0, 'ç³»çµ±å•Ÿå‹•å¤±æ•—', `éŒ¯èª¤: ${error.message}`);
                throw error;
            }
        }

        // å–®å€‹è…³æœ¬è¼‰å…¥å‡½æ•¸
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`è¼‰å…¥æˆåŠŸ: ${src}`);
                    resolve();
                };
                script.onerror = (error) => {
                    console.error(`è¼‰å…¥å¤±æ•—: ${src}`, error);
                    reject(new Error(`Script load failed: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // ä¸¦è¡Œè¼‰å…¥å¤šå€‹æ¨¡çµ„çš„å„ªåŒ–å‡½æ•¸
        function loadModulesInParallel(version) {
            return new Promise((resolve, reject) => {
                console.log('é–‹å§‹ä¸¦è¡Œè¼‰å…¥æ¨¡çµ„ç­–ç•¥...');
                
                // éšæ®µ1ï¼šé—œéµä¾è³´æ¨¡çµ„ï¼ˆå¿…é ˆæŒ‰é †åºï¼‰
                const criticalModules = [
                    'logger.js',              // Loggerç³»çµ± - æœ€æœ€å„ªå…ˆè¼‰å…¥
                    'timestamp-utils.js',     // æ™‚é–“æˆ³å·¥å…· - æœ€å„ªå…ˆè¼‰å…¥
                    'data-validator.js',      // æ•¸æ“šé©—è­‰å™¨ - ç¬¬äºŒå„ªå…ˆ
                    'error-monitor.js',       // éŒ¯èª¤ç›£æ§å™¨ - ç¬¬ä¸‰å„ªå…ˆ
                    'candleAggregator.js',
                    'config.js'
                ];
                
                // éšæ®µ2ï¼šæ ¸å¿ƒç®¡ç†å™¨æ¨¡çµ„ï¼ˆå¯ä¸¦è¡Œï¼‰
                const coreModules = [
                    'chart-manager.js',
                    'data-manager.js'
                ];
                
                // éšæ®µ3ï¼šè¼”åŠ©æ¨¡çµ„ï¼ˆå¯ä¸¦è¡Œï¼‰
                const auxiliaryModules = [
                    'playback-manager.js',
                    'event-manager.js'
                ];
                
                // éšæ®µ4ï¼šFVGæ¸²æŸ“å™¨ï¼ˆæ™ºèƒ½è¼‰å…¥æ¨¡å¼ï¼‰
                
                // æª¢æ¸¬è¼‰å…¥æ¨¡å¼
                function detectLoadingMode() {
                    // å„ªå…ˆæª¢æŸ¥URLåƒæ•¸
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlMode = urlParams.get('mode');
                    
                    if (urlMode === 'debug') return 'debug';
                    if (urlMode === 'dev' || urlMode === 'development') return 'development';
                    if (urlMode === 'production') return 'production';
                    
                    // æª¢æŸ¥æœ¬åœ°å­˜å„²
                    const savedMode = localStorage.getItem('smartLoadingMode');
                    if (savedMode && ['production', 'debug', 'development'].includes(savedMode)) {
                        return savedMode;
                    }
                    
                    return 'production';  // é»˜èªç”Ÿç”¢æ¨¡å¼
                }
                
                // æ ¹æ“šæ¨¡å¼é¸æ“‡FVGæ¸²æŸ“å™¨
                function getFVGRenderersForMode(mode) {
                    const rendererConfigs = {
                        production: {
                            description: 'ç”Ÿç”¢æ¨¡å¼ - æœ€ä½³æ€§èƒ½',
                            renderers: [
                                'fvg-renderer-optimized.js'  // åªè¼‰å…¥å„ªåŒ–ç‰ˆæœ¬
                            ]
                        },
                        debug: {
                            description: 'èª¿è©¦æ¨¡å¼ - åŒ…å«èª¿è©¦å·¥å…·',
                            renderers: [
                                'fvg-renderer-optimized.js',      // ä¸»è¦æ¸²æŸ“å™¨
                                'fvg-renderer-ultra-minimal.js',  // æ¥µç°¡èª¿è©¦ç‰ˆæœ¬
                                'fvg-renderer-safe.js'            // å®‰å…¨èª¿è©¦ç‰ˆæœ¬
                            ]
                        },
                        development: {
                            description: 'é–‹ç™¼æ¨¡å¼ - å®Œæ•´åŠŸèƒ½',
                            renderers: [
                                'fvg-renderer-optimized.js',     // é«˜æ€§èƒ½å„ªåŒ–æ¸²æŸ“å™¨
                                'fvg-renderer-multiline.js',     // å¤šç·šæ¢æ¸²æŸ“å™¨ï¼ˆå‚™ç”¨ï¼‰
                                'fvg-renderer-ultra-minimal.js', // è¶…ç´šç°¡åŒ–æ¸²æŸ“å™¨
                                'fvg-renderer-safe.js',          // å®‰å…¨æ¸²æŸ“å™¨
                                'fvg-renderer-fixed.js',         // ä¿®å¾©æ¸²æŸ“å™¨
                                'fvg-renderer-minimal.js'        // æ¥µç°¡æ¸²æŸ“å™¨
                            ]
                        }
                    };
                    
                    return rendererConfigs[mode] || rendererConfigs.production;
                }
                
                const loadingMode = detectLoadingMode();
                const rendererConfig = getFVGRenderersForMode(loadingMode);
                const fvgRenderers = rendererConfig.renderers;
                
                // æ™ºèƒ½æ—¥èªŒè¼¸å‡º (æª¢æŸ¥Loggeræ˜¯å¦å¯ç”¨)
                const smartLog = {
                    info: (msg, data) => {
                        if (window.log) {
                            window.log.loading(msg, data);
                        } else {
                            console.log(`ğŸ“¦ ${msg}`, data || '');
                        }
                    },
                    system: (msg, data) => {
                        if (window.log) {
                            window.log.system(msg, data);
                        } else {
                            console.log(`ğŸ”§ ${msg}`, data || '');
                        }
                    }
                };
                
                smartLog.system(`è¼‰å…¥æ¨¡å¼: ${loadingMode} (${rendererConfig.description})`);
                smartLog.info(`FVGæ¸²æŸ“å™¨: ${fvgRenderers.length} å€‹æ¨¡çµ„`, fvgRenderers);
                
                let currentStage = 1;
                const totalStages = 4;
                
                // éšæ®µ1ï¼šè¼‰å…¥é—œéµä¾è³´ï¼ˆåºåˆ—è¼‰å…¥ï¼‰
                smartLog.info('éšæ®µ1: è¼‰å…¥é—œéµä¾è³´æ¨¡çµ„...');
                updateProgress(55, 'è¼‰å…¥é—œéµä¾è³´...', 'è¼‰å…¥ CandleAggregator å’Œ Config');
                
                loadModulesSequentially(criticalModules)
                    .then(() => {
                        smartLog.info('éšæ®µ1å®Œæˆï¼Œé–‹å§‹éšæ®µ2: ä¸¦è¡Œè¼‰å…¥æ ¸å¿ƒæ¨¡çµ„...');
                        currentStage = 2;
                        updateProgress(65, 'ä¸¦è¡Œè¼‰å…¥æ ¸å¿ƒæ¨¡çµ„...', 'è¼‰å…¥ Chart å’Œ Data ç®¡ç†å™¨');
                        
                        // éšæ®µ2ï¼šä¸¦è¡Œè¼‰å…¥æ ¸å¿ƒæ¨¡çµ„
                        return Promise.all(coreModules.map(module => loadScript(module)));
                    })
                    .then(() => {
                        smartLog.info('éšæ®µ2å®Œæˆï¼Œé–‹å§‹éšæ®µ3: ä¸¦è¡Œè¼‰å…¥è¼”åŠ©æ¨¡çµ„...');
                        currentStage = 3;
                        updateProgress(75, 'ä¸¦è¡Œè¼‰å…¥è¼”åŠ©æ¨¡çµ„...', 'è¼‰å…¥ Playback å’Œ Event ç®¡ç†å™¨');
                        
                        // éšæ®µ3ï¼šä¸¦è¡Œè¼‰å…¥è¼”åŠ©æ¨¡çµ„
                        return Promise.all(auxiliaryModules.map(module => loadScript(module)));
                    })
                    .then(() => {
                        smartLog.info('éšæ®µ3å®Œæˆï¼Œé–‹å§‹éšæ®µ4: è¼‰å…¥FVGæ¸²æŸ“å™¨...');
                        currentStage = 4;
                        updateProgress(80, 'è¼‰å…¥FVGæ¸²æŸ“å™¨...', 'è¼‰å…¥ç°¡å–®å’Œå¤šç·šæ¢æ¸²æŸ“å™¨');
                        
                        // éšæ®µ4ï¼šè¼‰å…¥FVGæ¸²æŸ“å™¨ï¼ˆç°¡å–®+å¤šç·šæ¢ç‰ˆæœ¬ï¼‰
                        return Promise.all(fvgRenderers.map(renderer => loadScript(renderer)));
                    })
                    .then(() => {
                        console.log('æ‰€æœ‰æ¨¡çµ„è¼‰å…¥å®Œæˆï¼');
                        updateProgress(82, 'æ¨¡çµ„è¼‰å…¥å®Œæˆ', 'æ‰€æœ‰æ ¸å¿ƒæ¨¡çµ„è¼‰å…¥æˆåŠŸ');
                        resolve();
                    })
                    .catch(error => {
                        console.error('æ¨¡çµ„è¼‰å…¥å¤±æ•—:', error);
                        updateProgress(60, 'æ¨¡çµ„è¼‰å…¥å¤±æ•—', `éŒ¯èª¤: ${error.message}`);
                        reject(error);
                    });
            });
        }

        // åºåˆ—è¼‰å…¥æ¨¡çµ„å‡½æ•¸
        function loadModulesSequentially(modules) {
            return modules.reduce((promise, module) => {
                return promise.then(() => loadScript(module));
            }, Promise.resolve());
        }

        // ç«‹å³å•Ÿå‹•ï¼Œä¸ç­‰å¾…DOMè¼‰å…¥ï¼ˆè…³æœ¬åœ¨bodyæœ«å°¾ï¼ŒDOMå·²ç¶“å­˜åœ¨ï¼‰
        console.log('é–‹å§‹ç³»çµ±åˆå§‹åŒ–');
        
        // å…¨åŸŸè®Šæ•¸ä¾†å­˜å„² backendMonitor
        let globalBackendMonitor = null;
        
        // ç«‹å³æª¢æŸ¥å¾Œç«¯ç‹€æ…‹ä¸¦é¡¯ç¤ºé€²åº¦
        async function initializeSystem() {
            try {
                const response = await fetch('http://127.0.0.1:5001/api/loading-status');
                if (response.ok) {
                    const status = await response.json();
                    console.log('å¾Œç«¯ç‹€æ…‹:', status);
                    
                    if (!status.is_loading) {
                        // å¾Œç«¯å·²å®Œæˆï¼Œç›´æ¥é¡¯ç¤ºå®Œæˆç‹€æ…‹
                        updateProgress(100, 'å¾Œç«¯è¼‰å…¥å®Œæˆï¼Œé–‹å§‹å‰ç«¯åˆå§‹åŒ–...', 'é–‹å§‹è¼‰å…¥å‰ç«¯æ¨¡çµ„');
                        console.log('å¾Œç«¯å·²å®Œæˆè¼‰å…¥ï¼Œé–‹å§‹å‰ç«¯æµç¨‹');
                    } else {
                        // å¾Œç«¯é‚„åœ¨è¼‰å…¥ï¼Œå•Ÿå‹•ç›£æ§
                        updateProgress(status.progress, status.current_step, status.current_file);
                    }
                } else {
                    console.warn('ç„¡æ³•é€£æ¥å¾Œç«¯ï¼Œç¹¼çºŒå‰ç«¯è¼‰å…¥');
                    updateProgress(50, 'å¾Œç«¯é€£æ¥ç•°å¸¸ï¼Œç¹¼çºŒå‰ç«¯è¼‰å…¥...', 'æº–å‚™è¼‰å…¥å‰ç«¯æ¨¡çµ„');
                }
            } catch (error) {
                console.log('å¾Œç«¯æª¢æŸ¥å¤±æ•—ï¼Œç¹¼çºŒå‰ç«¯è¼‰å…¥:', error);
                updateProgress(50, 'å¾Œç«¯æª¢æŸ¥å¤±æ•—ï¼Œç¹¼çºŒå‰ç«¯è¼‰å…¥...', 'æº–å‚™è¼‰å…¥å‰ç«¯æ¨¡çµ„');
            }
            
            // å•Ÿå‹•å¾Œç«¯è¼‰å…¥ç›£æ§ï¼ˆå¦‚æœéœ€è¦ï¼‰
            globalBackendMonitor = startBackendLoadingMonitor();
            
            // å„ªåŒ–ç‰ˆä¸¦è¡Œè¼‰å…¥ç³»çµ±
            return startSystem();
        }
        
        // å•Ÿå‹•ç³»çµ±åˆå§‹åŒ–
        initializeSystem().then((detectedVersion) => {
            console.log('Lightweight Charts ç‰ˆæœ¬ç¢ºèª:', detectedVersion);
            updateProgress(50, 'é–‹å§‹ä¸¦è¡Œè¼‰å…¥æ¨¡çµ„...', 'æº–å‚™è¼‰å…¥æ ¸å¿ƒæ¨¡çµ„');
            
            // ä¸¦è¡Œè¼‰å…¥ç­–ç•¥ï¼šé—œéµæ¨¡çµ„ä¸¦è¡Œè¼‰å…¥
            return loadModulesInParallel(detectedVersion).then(() => detectedVersion);
        }).then((version) => {
                console.log('æ‰€æœ‰æ¨¡çµ„è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è¼‰å…¥ä¸»ç¨‹å¼');
                updateProgress(85, 'è¼‰å…¥ä¸»ç¨‹å¼...', 'æ‰€æœ‰æ¨¡çµ„è¼‰å…¥å®Œæˆ');
                
                // æœ€å¾Œè¼‰å…¥ä¸»ç¨‹å¼
                return loadScript('script-v2.js').then(() => version);
            })
            .then((version) => {
                console.log('script-v2.js è¼‰å…¥æˆåŠŸ');
                updateProgress(95, 'åˆå§‹åŒ–ç³»çµ±...', 'ä¸»ç¨‹å¼è¼‰å…¥å®Œæˆ');
                
                // ç›£è½JavaScriptéŒ¯èª¤
                window.addEventListener('error', (event) => {
                    console.error('JavaScriptéŒ¯èª¤:', event.error);
                    const errorMessage = event.error && event.error.message ? event.error.message : 'æœªçŸ¥éŒ¯èª¤';
                    updateProgress(95, 'ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤', `éŒ¯èª¤: ${errorMessage}`);
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('PromiseéŒ¯èª¤:', event.reason);
                    updateProgress(95, 'ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤', `PromiseéŒ¯èª¤: ${event.reason}`);
                });
                
                // è©³ç´°ç›£æ§ç³»çµ±åˆå§‹åŒ–
                let initCheckCount = 0;
                const maxChecks = 20; // æœ€å¤šæª¢æŸ¥20æ¬¡ (10ç§’)
                
                const initChecker = setInterval(() => {
                    initCheckCount++;
                    
                    console.log(`[åˆå§‹åŒ–æª¢æŸ¥ ${initCheckCount}/${maxChecks}] window.app:`, !!window.app);
                    if (window.app) {
                        console.log('window.app.chart:', !!window.app.chart);
                        console.log('window.app.chartManager:', !!window.app.chartManager);
                        console.log('window.app.error:', window.app.error);
                        if (window.app.error) {
                            console.log('window.app.errorMessage:', window.app.errorMessage);
                        }
                    }
                    
                    if (window.app && window.app.chart && !window.app.error) {
                        // æˆåŠŸåˆå§‹åŒ–
                        clearInterval(initChecker);
                        const chartVersion = version;
                        document.getElementById('chart-version').textContent = `åœ–è¡¨: ${chartVersion}`;
                        updateProgress(100, 'ç³»çµ±å°±ç·’ï¼', 'äº¤æ˜“åœ–è¡¨ç³»çµ±å•Ÿå‹•å®Œæˆ');
                        
                        // åˆå§‹åŒ–FVGå¤šç·šæ¢æ¸²æŸ“å™¨æ§åˆ¶é …ç›®
                        initializeFVGControls();
                        
                        // åœæ­¢å¾Œç«¯ç›£æ§ä¸¦éš±è—è¼‰å…¥è¦†è“‹å±¤
                        if (globalBackendMonitor) {
                            globalBackendMonitor.stop();
                        }
                        setTimeout(() => {
                            const loadingOverlay = document.getElementById('loading-overlay');
                            if (loadingOverlay) {
                                loadingOverlay.style.opacity = '0';
                                setTimeout(() => {
                                    loadingOverlay.style.display = 'none';
                                }, 500);
                            }
                            // èˆŠçš„é€²åº¦æ¢ä¹Ÿéš±è—
                            const v5Loading = document.getElementById('v5-loading');
                            if (v5Loading) {
                                v5Loading.style.display = 'none';
                            }
                        }, 2000);
                        
                    } else if (window.app && window.app.error) {
                        // åˆå§‹åŒ–å¤±æ•—ï¼Œä½†æœ‰éŒ¯èª¤ä¿¡æ¯
                        clearInterval(initChecker);
                        updateProgress(90, 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—', `éŒ¯èª¤: ${window.app.errorMessage}`);
                        console.error('ç³»çµ±åˆå§‹åŒ–å¤±æ•—:', window.app.errorMessage);
                        
                    } else if (initCheckCount >= maxChecks) {
                        // è¶…æ™‚å¤±æ•—
                        clearInterval(initChecker);
                        updateProgress(90, 'ç³»çµ±åˆå§‹åŒ–è¶…æ™‚', 'è«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯');
                        console.error('ç³»çµ±åˆå§‹åŒ–è¶…æ™‚ - è«‹æª¢æŸ¥æ˜¯å¦æœ‰JavaScriptéŒ¯èª¤');
                        
                    } else {
                        // æ›´æ–°ç­‰å¾…ç‹€æ…‹
                        const waitMsg = `ç­‰å¾…ç³»çµ±åˆå§‹åŒ– (${initCheckCount}/${maxChecks})`;
                        updateProgress(90 + (initCheckCount / maxChecks) * 8, waitMsg, `æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼ç‰©ä»¶...`);
                    }
                }, 500); // æ¯500msæª¢æŸ¥ä¸€æ¬¡
            })
            .catch(error => {
                console.error('åœ–è¡¨åº«è¼‰å…¥å¤±æ•—:', error);
                alert('åœ–è¡¨åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–å˜—è©¦é‡æ–°æ•´ç†é é¢ã€‚');
            });
            
        // CandleAggregatorè…³æœ¬åˆå§‹åŒ–éƒ¨åˆ†
        const aggregatorScript = document.createElement('script');
        aggregatorScript.src = 'candleAggregator.js';
        aggregatorScript.onload = () => {
            console.log('CandleAggregator è¼‰å…¥å®Œæˆ');
        };
        
        aggregatorScript.onerror = () => {
            console.error('CandleAggregator è¼‰å…¥å¤±æ•—');
            alert('ç³»çµ±è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚');
        };
        
        document.head.appendChild(aggregatorScript);
            
        // ========== FVG å¤šç·šæ¢æ¸²æŸ“å™¨æ§åˆ¶é …ç›®åˆå§‹åŒ– ==========
        
        function initializeFVGControls() {
            console.log('ğŸ›ï¸ åˆå§‹åŒ–FVGæ§åˆ¶é …ç›®');
            
            try {
                // ç²å–æ§åˆ¶é …ç›®å…ƒç´ 
                const fvgCheckbox = document.getElementById('fvg-checkbox');
                const fvgMarkersCheckbox = document.getElementById('fvg-markers-checkbox');
                const fvgClearedCheckbox = document.getElementById('fvg-cleared-checkbox');
                const fvgPerformanceMode = document.getElementById('fvg-performance-mode');
                const fvgPrimitivesCount = document.getElementById('fvg-primitives-count');
                const fvgMarkersCount = document.getElementById('fvg-markers-count');
                
                // æª¢æŸ¥å¿…è¦å…ƒç´ æ˜¯å¦å­˜åœ¨
                if (!fvgCheckbox) {
                    console.error('âŒ ä¸»è¦FVGæ§åˆ¶é …ç›®æœªæ‰¾åˆ°');
                    return;
                }
                
                // è¨­ç½®åˆå§‹ç‹€æ…‹
                const config = window.CONFIG?.FVG || {};
                if (fvgMarkersCheckbox) fvgMarkersCheckbox.checked = config.DEFAULT_SHOW_MARKERS || false;
                if (fvgClearedCheckbox) fvgClearedCheckbox.checked = config.DEFAULT_SHOW_CLEARED || false;
                
                // ä¸»è¦FVGé–‹é—œäº‹ä»¶
                fvgCheckbox.addEventListener('change', function(e) {
                    console.log(`ğŸ›ï¸ FVGé¡¯ç¤º: ${e.target.checked ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
                    
                    if (window.app?.chartManager?.fvgRenderer) {
                        window.app.chartManager.fvgRenderer.toggle();
                        if (window.app.dataManager?.currentData?.fvgs) {
                            window.app.chartManager.fvgRenderer.render(
                                window.app.dataManager.currentData.fvgs,
                                window.app.dataManager.currentTimeframe
                            );
                        }
                        updateFVGStats();
                    }
                });
                
                // FVGæ¨™è¨˜é–‹é—œäº‹ä»¶
                if (fvgMarkersCheckbox) {
                    fvgMarkersCheckbox.addEventListener('change', function(e) {
                        console.log(`ğŸ·ï¸ FVGæ¨™è¨˜: ${e.target.checked ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
                        
                        if (window.app?.chartManager?.fvgRenderer) {
                            window.app.chartManager.fvgRenderer.toggleMarkers();
                            if (window.app.dataManager?.currentData?.fvgs) {
                                window.app.chartManager.fvgRenderer.render(
                                    window.app.dataManager.currentData.fvgs,
                                    window.app.dataManager.currentTimeframe
                                );
                            }
                            updateFVGStats();
                        }
                    });
                }
                
                // å·²æ¸…é™¤FVGé–‹é—œäº‹ä»¶
                if (fvgClearedCheckbox) {
                    fvgClearedCheckbox.addEventListener('change', function(e) {
                        console.log(`ğŸ‘» å·²æ¸…é™¤FVG: ${e.target.checked ? 'é–‹å•Ÿ' : 'é—œé–‰'}`);
                        
                        if (window.app?.chartManager?.fvgRenderer) {
                            window.app.chartManager.fvgRenderer.toggleClearedFVGs();
                            if (window.app.dataManager?.currentData?.fvgs) {
                                window.app.chartManager.fvgRenderer.render(
                                    window.app.dataManager.currentData.fvgs,
                                    window.app.dataManager.currentTimeframe
                                );
                            }
                            updateFVGStats();
                        }
                    });
                }
                
                // æ€§èƒ½æ¨¡å¼é¸æ“‡äº‹ä»¶
                if (fvgPerformanceMode) {
                    fvgPerformanceMode.addEventListener('change', function(e) {
                        const mode = e.target.value;
                        console.log(`âš™ï¸ FVGæ€§èƒ½æ¨¡å¼: ${mode}`);
                        
                        if (window.app?.chartManager?.fvgRenderer) {
                            const modes = { 
                                high: 130, 
                                balanced: 60, 
                                performance: 20 
                            };
                            
                            window.app.chartManager.fvgRenderer.setMaxLines(modes[mode]);
                            
                            // é‡æ–°æ¸²æŸ“ä»¥æ‡‰ç”¨æ–°è¨­ç½®
                            if (window.app.dataManager?.currentData?.fvgs) {
                                window.app.chartManager.fvgRenderer.render(
                                    window.app.dataManager.currentData.fvgs,
                                    window.app.dataManager.currentTimeframe
                                );
                            }
                            updateFVGStats();
                        }
                    });
                }
                
                // æ›´æ–°çµ±è¨ˆä¿¡æ¯å‡½æ•¸
                function updateFVGStats() {
                    if (window.app?.chartManager?.fvgRenderer && fvgPrimitivesCount && fvgMarkersCount) {
                        const stats = window.app.chartManager.fvgRenderer.getStats();
                        fvgPrimitivesCount.textContent = stats.totalPrimitives || '0';
                        fvgMarkersCount.textContent = stats.totalMarkers || '0';
                    }
                }
                
                // å®šæ™‚æ›´æ–°çµ±è¨ˆä¿¡æ¯
                setInterval(updateFVGStats, 2000);
                
                // åˆå§‹çµ±è¨ˆæ›´æ–°
                setTimeout(updateFVGStats, 1000);
                
                console.log('âœ… FVGæ§åˆ¶é …ç›®åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ FVGæ§åˆ¶é …ç›®åˆå§‹åŒ–å¤±æ•—:', error);
            }
        }
        
        // ========== è¼”åŠ©å‡½æ•¸ ==========
        
        // åˆ·æ–°FVGé¡¯ç¤º
        function refreshFVGDisplay() {
            if (window.app?.chartManager?.fvgRenderer && window.app.dataManager?.currentData?.fvgs) {
                console.log('ğŸ”„ åˆ·æ–°FVGé¡¯ç¤º');
                window.app.chartManager.fvgRenderer.render(
                    window.app.dataManager.currentData.fvgs,
                    window.app.dataManager.currentTimeframe
                );
            }
        }
        
        // æš´éœ²åˆ°å…¨åŸŸä»¥ä¾›èª¿è©¦
        window.refreshFVGDisplay = refreshFVGDisplay;
        
        // ========== FVGå®Œæ•´è¨ºæ–·ç³»çµ± ==========
        
        window.runFullFVGDiagnostics = function() {
            console.group('ğŸ” FVGç³»çµ±å®Œæ•´è¨ºæ–·');
            
            console.log('ğŸ“Š ç¬¬1æ­¥: ç³»çµ±æ¶æ§‹æª¢æŸ¥');
            console.log('   - chartManagerå­˜åœ¨:', !!window.app?.chartManager);
            console.log('   - dataManagerå­˜åœ¨:', !!window.app?.dataManager);
            console.log('   - FVGRendererMultilineé¡å¯ç”¨:', typeof window.FVGRendererMultiline);
            
            if (window.app?.chartManager) {
                const chartManager = window.app.chartManager;
                console.log('   - FVGæ¸²æŸ“å™¨å·²åˆå§‹åŒ–:', !!chartManager.fvgRenderer);
                console.log('   - æ¸²æŸ“å™¨é¡å‹:', chartManager.fvgRenderer?.constructor.name);
                console.log('   - ä½¿ç”¨å„ªåŒ–æ¸²æŸ“å™¨:', chartManager.isUsingOptimizedRenderer?.() || false);
            }
            
            console.log('ğŸ“Š ç¬¬2æ­¥: æ•¸æ“šç‹€æ…‹æª¢æŸ¥');
            
            // æª¢æŸ¥å¤šå€‹å¯èƒ½çš„æ•¸æ“šæº
            let data = window.app?.dataManager?.currentData || window.currentData;
            console.log('   - dataManager.currentDataå­˜åœ¨:', !!window.app?.dataManager?.currentData);
            console.log('   - window.currentDataå­˜åœ¨:', !!window.currentData);
            
            if (data) {
                console.log('   - ç•¶å‰æ•¸æ“šå­˜åœ¨:', !!data);
                console.log('   - æ—¥æœŸ:', data.date);
                console.log('   - Kç·šæ•¸æ“š:', data.data ? data.data.length + 'æ ¹' : 'ç„¡');
                console.log('   - FVGæ•¸æ“š:', data.fvgs ? data.fvgs.length + 'å€‹' : 'ç„¡');
                
                if (data.fvgs && data.fvgs.length > 0) {
                    const valid = data.fvgs.filter(f => f.status === 'valid');
                    const cleared = data.fvgs.filter(f => f.status === 'cleared');
                    console.log('   - æœ‰æ•ˆFVG:', valid.length + 'å€‹');
                    console.log('   - å·²æ¸…é™¤FVG:', cleared.length + 'å€‹');
                    
                    const sample = data.fvgs[0];
                    console.log('   - æ¨£æœ¬FVGå®Œæ•´æ€§:');
                    console.log('     * type:', sample.type);
                    console.log('     * status:', sample.status);
                    console.log('     * topPrice:', sample.topPrice);
                    console.log('     * bottomPrice:', sample.bottomPrice);
                    console.log('     * startTime:', sample.startTime);
                    console.log('     * endTime:', sample.endTime);
                } else {
                    console.warn('âŒ æ²’æœ‰FVGæ•¸æ“š');
                }
            } else {
                console.warn('âŒ æ²’æœ‰ç•¶å‰æ•¸æ“š');
            }
            
            console.log('ğŸ“Š ç¬¬3æ­¥: æ§åˆ¶é …ç‹€æ…‹æª¢æŸ¥');
            const fvgCheckbox = document.getElementById('fvg-checkbox');
            const fvgClearedCheckbox = document.getElementById('fvg-cleared-checkbox');
            const fvgMarkersCheckbox = document.getElementById('fvg-markers-checkbox');
            
            console.log('   - ä¸»FVGè¤‡é¸æ¡†:', fvgCheckbox ? (fvgCheckbox.checked ? 'âœ…å·²å‹¾é¸' : 'âŒæœªå‹¾é¸') : 'âŒä¸å­˜åœ¨');
            console.log('   - å·²æ¸…é™¤FVGè¤‡é¸æ¡†:', fvgClearedCheckbox ? (fvgClearedCheckbox.checked ? 'âœ…å·²å‹¾é¸' : 'âŒæœªå‹¾é¸') : 'âŒä¸å­˜åœ¨');
            console.log('   - FVGæ¨™è¨˜è¤‡é¸æ¡†:', fvgMarkersCheckbox ? (fvgMarkersCheckbox.checked ? 'âœ…å·²å‹¾é¸' : 'âŒæœªå‹¾é¸') : 'âŒä¸å­˜åœ¨');
            
            console.log('ğŸ“Š ç¬¬4æ­¥: æ¸²æŸ“å™¨è©³ç´°è¨ºæ–·');
            if (window.app?.chartManager?.fvgRenderer && typeof window.diagnoseFVGRenderer === 'function') {
                console.log('   - é‹è¡Œæ¸²æŸ“å™¨å…§éƒ¨è¨ºæ–·...');
                const rendererDiag = window.diagnoseFVGRenderer();
                console.log('   - æ¸²æŸ“å™¨è¨ºæ–·çµæœ:', rendererDiag);
            } else {
                console.warn('   - æ¸²æŸ“å™¨è¨ºæ–·ä¸å¯ç”¨');
            }
            
            console.log('ğŸ“Š ç¬¬5æ­¥: æ‰‹å‹•æ¸²æŸ“æ¸¬è©¦');
            if (window.app?.chartManager?.fvgRenderer && window.app?.dataManager?.currentData?.fvgs) {
                console.log('   - å˜—è©¦æ‰‹å‹•è§¸ç™¼FVGæ¸²æŸ“...');
                try {
                    window.app.chartManager.fvgRenderer.render(
                        window.app.dataManager.currentData.fvgs, 
                        window.app.dataManager.currentTimeframe || 'M15'
                    );
                    console.log('   âœ… æ‰‹å‹•æ¸²æŸ“å‘½ä»¤å·²åŸ·è¡Œ');
                } catch (e) {
                    console.error('   âŒ æ‰‹å‹•æ¸²æŸ“å¤±æ•—:', e);
                }
            }
            
            console.log('ğŸ“Š è¨ºæ–·å»ºè­°:');
            const suggestions = [];
            
            if (!window.app?.chartManager?.fvgRenderer) {
                suggestions.push('é‡æ–°è¼‰å…¥é é¢ä»¥åˆå§‹åŒ–FVGæ¸²æŸ“å™¨');
            }
            if (!window.app?.dataManager?.currentData?.fvgs) {
                suggestions.push('é»æ“Š"éš¨æ©Ÿæ—¥æœŸ"æŒ‰éˆ•è¼‰å…¥åŒ…å«FVGçš„æ•¸æ“š');
            }
            if (!fvgCheckbox?.checked) {
                suggestions.push('å‹¾é¸å·¦å´é¢æ¿çš„"Fair Value Gap (FVG)"è¤‡é¸æ¡†');
            }
            if (!fvgClearedCheckbox?.checked) {
                suggestions.push('å‹¾é¸"é¡¯ç¤ºå·²æ¸…é™¤FVG"ä»¥æŸ¥çœ‹æ›´å¤šFVG');
            }
            
            if (suggestions.length === 0) {
                console.log('   âœ… ç³»çµ±ç‹€æ…‹çœ‹èµ·ä¾†æ­£å¸¸ï¼ŒFVGæ‡‰è©²å¯ä»¥æ­£å¸¸é¡¯ç¤º');
                console.log('   ğŸ“Œ å¦‚æœä»çœ‹ä¸åˆ°FVGï¼Œè«‹æª¢æŸ¥åœ–è¡¨ç¸®æ”¾ç´šåˆ¥æˆ–æ™‚é–“ç¯„åœ');
            } else {
                suggestions.forEach((suggestion, index) => {
                    console.log(`   ${index + 1}. ${suggestion}`);
                });
            }
            
            console.groupEnd();
        };
        
        // å¿«é€ŸFVGç‹€æ…‹æª¢æŸ¥å‡½æ•¸
        window.quickFVGCheck = function() {
            console.log('ğŸš€ å¿«é€ŸFVGç‹€æ…‹æª¢æŸ¥:');
            console.log('   æ¸²æŸ“å™¨:', !!window.app?.chartManager?.fvgRenderer ? 'âœ…' : 'âŒ');
            console.log('   æ•¸æ“š:', !!window.app?.dataManager?.currentData?.fvgs ? 'âœ…' : 'âŒ');
            console.log('   æœ¬åœ°æ•¸æ“š:', !!window.currentData?.fvgs ? 'âœ…' : 'âŒ');
            console.log('   è¤‡é¸æ¡†:', !!document.getElementById('fvg-checkbox')?.checked ? 'âœ…' : 'âŒ');
            console.log('   åœ–å…ƒæ•¸é‡:', window.app?.chartManager?.fvgRenderer?.fvgPrimitives?.length || 0);
        };
        
        // æ‰‹å‹•è¼‰å…¥æ¸¬è©¦æ•¸æ“šå‡½æ•¸
        window.testLoadRandomData = async function() {
            console.log('ğŸ§ª æ‰‹å‹•è¼‰å…¥æ¸¬è©¦æ•¸æ“š...');
            try {
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    console.log('   é»æ“Šéš¨æ©Ÿæ—¥æœŸæŒ‰éˆ•...');
                    refreshBtn.click();
                    
                    // ç­‰å¾…3ç§’å¾Œæª¢æŸ¥çµæœ
                    setTimeout(() => {
                        console.log('ğŸ“Š è¼‰å…¥çµæœæª¢æŸ¥:');
                        console.log('   å…¨åŸŸcurrentData:', !!window.currentData);
                        console.log('   FVGæ•¸æ“š:', window.currentData?.fvgs?.length || 0);
                        if (window.currentData?.fvgs) {
                            const valid = window.currentData.fvgs.filter(f => f.status === 'valid');
                            const cleared = window.currentData.fvgs.filter(f => f.status === 'cleared');
                            console.log('   æœ‰æ•ˆFVG:', valid.length);
                            console.log('   å·²æ¸…é™¤FVG:', cleared.length);
                        }
                        console.log('   åœ–å…ƒæ•¸é‡:', window.app?.chartManager?.fvgRenderer?.fvgPrimitives?.length || 0);
                    }, 3000);
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°åˆ·æ–°æŒ‰éˆ•');
                }
            } catch (e) {
                console.error('âŒ æ¸¬è©¦è¼‰å…¥å¤±æ•—:', e);
            }
        };
        
        // ===== æ™ºèƒ½è¼‰å…¥æ¨¡å¼åˆ‡æ›åŠŸèƒ½ =====
        
        // æ¨¡å¼åˆ‡æ›åŠŸèƒ½
        window.switchLoadingMode = function(mode) {
            if (!['production', 'debug', 'development'].includes(mode)) {
                console.error('ç„¡æ•ˆçš„è¼‰å…¥æ¨¡å¼:', mode);
                return;
            }
            
            console.log(`ğŸ”„ åˆ‡æ›è¼‰å…¥æ¨¡å¼åˆ°: ${mode}`);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('smartLoadingMode', mode);
            
            // æ›´æ–°URLåƒæ•¸
            const url = new URL(window.location);
            url.searchParams.set('mode', mode);
            
            // é‡æ–°è¼‰å…¥é é¢ä»¥æ‡‰ç”¨æ–°æ¨¡å¼
            window.location = url.toString();
        };
        
        // æ›´æ–°æ¨¡å¼åˆ‡æ›å™¨UI
        function updateModeUI() {
            const currentMode = detectLoadingMode();
            
            // æ›´æ–°ç•¶å‰æ¨¡å¼é¡¯ç¤º
            const currentModeElement = document.getElementById('current-mode');
            if (currentModeElement) {
                currentModeElement.textContent = currentMode;
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.mode-switcher button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeButton = document.getElementById(`mode-${currentMode}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            console.log(`ğŸ¯ ç•¶å‰è¼‰å…¥æ¨¡å¼: ${currentMode}`);
        }
        
        // åœ¨é é¢è¼‰å…¥å®Œæˆå¾Œæ›´æ–°UI
        document.addEventListener('DOMContentLoaded', function() {
            // ç¨å¾®å»¶é²ä»¥ç¢ºä¿æ¨¡å¼æª¢æ¸¬é‚è¼¯å·²åŸ·è¡Œ
            setTimeout(updateModeUI, 100);
        });
        
        // å¦‚æœDOMå·²ç¶“è¼‰å…¥å®Œæˆï¼Œç«‹å³æ›´æ–°UI
        if (document.readyState !== 'loading') {
            setTimeout(updateModeUI, 100);
        }
        
    </script>
</body>
</html>