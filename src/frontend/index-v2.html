<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易圖表系統 - 紐約開盤前分析</title>
    
    <!-- 性能優化：預載入關鍵資源 -->
    <link rel="preload" href="config.js" as="script">
    <link rel="preload" href="chart-manager.js" as="script">
    <link rel="preload" href="data-manager.js" as="script">
    <link rel="preload" href="fvg-renderer-optimized.js" as="script">
    <link rel="prefetch" href="playback-manager.js" as="script">
    <link rel="prefetch" href="event-manager.js" as="script">
    
    <link rel="stylesheet" href="style-v2.css">
    
    <!-- 智能載入模式切換器樣式 -->
    <style>
        .mode-switcher {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .mode-switcher button {
            margin: 0 2px;
            padding: 4px 8px;
            font-size: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mode-switcher button:hover {
            background: #555;
        }
        
        .mode-switcher button.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }
        
        .mode-info {
            margin-top: 4px;
            font-size: 10px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- 智能載入模式切換器 -->
    <div class="mode-switcher">
        <div>載入模式:</div>
        <button onclick="switchLoadingMode('production')" id="mode-production">生產</button>
        <button onclick="switchLoadingMode('debug')" id="mode-debug">調試</button>
        <button onclick="switchLoadingMode('development')" id="mode-development">開發</button>
        <div class="mode-info">
            <span>當前: </span><span id="current-mode">auto</span>
        </div>
    </div>

    <!-- 載入進度覆蓋層 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loading-header">
                <h2>交易圖表系統載入中</h2>
                <div class="loading-subtitle">正在初始化數據和功能模組...</div>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div id="progress-text" class="progress-text">0%</div>
                </div>
                
                <div id="current-step" class="current-step">準備載入資料...</div>
                <div id="current-file" class="current-file"></div>
                
                <div class="details-section">
                    <div id="time-info" class="time-info">
                        <span id="elapsed-time">已用時間: 0s</span>
                        <span id="estimated-time">預估剩餘: --</span>
                    </div>
                    <div id="loading-details" class="loading-details"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要佈局容器 -->
    <div class="main-layout">
        <!-- 左側固定技術指標面板 -->
        <div id="indicators-panel" class="indicators-panel">
            <!-- 面板控制區 -->
            <div class="panel-control">
                <button id="panel-toggle" class="panel-toggle" title="收合/展開">☰</button>
                <span class="panel-title">技術指標</span>
            </div>
            
            <!-- 指標內容區 -->
            <div class="indicators-content">
                <!-- 價格動作指標 -->
                <div class="indicator-category expanded" data-category="price-action">
                    <div class="indicator-category-header">
                        <span>價格動作</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="fvg-checkbox" checked>
                            <span class="indicator-name">Fair Value Gap (FVG)</span>
                            <button class="settings-btn" data-indicator="fvg" title="設定參數">⚙</button>
                        </label>
                        
                        <!-- FVG 子設定項目 -->
                        <div class="sub-indicator-list" id="fvg-sub-controls">
                            <label class="sub-indicator-item">
                                <input type="checkbox" id="fvg-markers-checkbox">
                                <span class="sub-indicator-name">FVG標記 (F1, F2...)</span>
                            </label>
                            
                            <label class="sub-indicator-item">
                                <input type="checkbox" id="fvg-cleared-checkbox">
                                <span class="sub-indicator-name">顯示已清除FVG</span>
                            </label>
                            
                            <div class="sub-indicator-item">
                                <label for="fvg-performance-mode" class="sub-indicator-name">性能模式:</label>
                                <select id="fvg-performance-mode" class="performance-select">
                                    <option value="high">高質量 (130線)</option>
                                    <option value="balanced">平衡 (60線)</option>
                                    <option value="performance">性能優先 (20線)</option>
                                </select>
                            </div>
                            
                            <div class="fvg-stats" id="fvg-stats">
                                <div class="stats-item">
                                    <span>渲染圖元:</span>
                                    <span id="fvg-primitives-count">-</span>
                                </div>
                                <div class="stats-item">
                                    <span>標記數量:</span>
                                    <span id="fvg-markers-count">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="sr-checkbox">
                            <span class="indicator-name">支撐阻力位</span>
                            <button class="settings-btn" data-indicator="sr" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="pivot-checkbox">
                            <span class="indicator-name">樞紐點</span>
                            <button class="settings-btn" data-indicator="pivot" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
                
                <!-- 移動平均線 -->
                <div class="indicator-category" data-category="moving-averages">
                    <div class="indicator-category-header">
                        <span>移動平均線</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="sma-checkbox">
                            <span class="indicator-name">簡單移動平均 (SMA)</span>
                            <button class="settings-btn" data-indicator="sma" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="ema-checkbox">
                            <span class="indicator-name">指數移動平均 (EMA)</span>
                            <button class="settings-btn" data-indicator="ema" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="bb-checkbox">
                            <span class="indicator-name">布林通道 (BB)</span>
                            <button class="settings-btn" data-indicator="bb" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
                
                <!-- 震盪指標 -->
                <div class="indicator-category" data-category="oscillators">
                    <div class="indicator-category-header">
                        <span>震盪指標</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="rsi-checkbox">
                            <span class="indicator-name">相對強弱指數 (RSI)</span>
                            <button class="settings-btn" data-indicator="rsi" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="macd-checkbox">
                            <span class="indicator-name">MACD</span>
                            <button class="settings-btn" data-indicator="macd" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="stoch-checkbox">
                            <span class="indicator-name">隨機指標 (Stochastic)</span>
                            <button class="settings-btn" data-indicator="stoch" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
                
                <!-- 成交量指標 -->
                <div class="indicator-category" data-category="volume">
                    <div class="indicator-category-header">
                        <span>成交量指標</span>
                        <span class="category-arrow">▶</span>
                    </div>
                    <div class="indicator-list">
                        <label class="indicator-item">
                            <input type="checkbox" id="volume-checkbox">
                            <span class="indicator-name">成交量</span>
                            <button class="settings-btn" data-indicator="volume" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="vwap-checkbox">
                            <span class="indicator-name">成交量加權平均價 (VWAP)</span>
                            <button class="settings-btn" data-indicator="vwap" title="設定參數">⚙</button>
                        </label>
                        
                        <label class="indicator-item">
                            <input type="checkbox" id="obv-checkbox">
                            <span class="indicator-name">能量潮 (OBV)</span>
                            <button class="settings-btn" data-indicator="obv" title="設定參數">⚙</button>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右側主內容區 -->
        <div class="main-content">
            <div class="container">
                <!-- 頂部控制面板 -->
                <div class="control-panel">
                    <div class="info-section">
                        <h1>交易圖表系統</h1>
                        <div class="date-info">
                            <span id="current-date">載入中...</span>
                            <span id="market-info">載入中...</span>
                            <span id="holiday-info" class="holiday-badge" style="display: none;">美國假日</span>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <!-- 操作按鈕 -->
                        <div class="action-buttons">
                            <button id="refresh-btn" class="btn btn-primary">隨機日期</button>
                            <button id="reset-zoom-btn" class="btn btn-secondary">重置縮放</button>
                            <button id="test-scaling-btn" class="btn btn-warning">測試縮放</button>
                            <button id="draw-line-btn" class="btn btn-tool">畫線</button>
                            <button id="clear-lines-btn" class="btn btn-danger">清除線</button>
                        </div>
                    </div>
                </div>
                
                <!-- 時間刻度分頁 -->
                <div class="timeframe-tabs">
                    <button class="tab-btn" data-timeframe="M1">M1</button>
                    <button class="tab-btn" data-timeframe="M5">M5</button>
                    <button class="tab-btn active" data-timeframe="M15">M15</button>
                    <button class="tab-btn" data-timeframe="H1">H1</button>
                    <button class="tab-btn" data-timeframe="H4">H4</button>
                    <button class="tab-btn" data-timeframe="D1">D1</button>
                </div>
                
                <!-- 播放控制面板 -->
                <div class="playback-panel">
                    <div class="playback-controls">
                        <button id="play-btn" class="btn btn-play">開始</button>
                        <button id="pause-btn" class="btn btn-pause" disabled>暫停</button>
                        
                        <div class="speed-selector">
                            <label>播放速度：</label>
                            <select id="speed-select">
                                <option value="1">1秒/根</option>
                                <option value="2">2秒/根</option>
                                <option value="5" selected>5秒/根</option>
                                <option value="10">10秒/根</option>
                                <option value="20">20秒/根</option>
                                <option value="30">30秒/根</option>
                            </select>
                        </div>
                        
                        <div class="playback-info">
                            <span id="playback-time">播放時間: --</span>
                            <span id="countdown">下一根: --</span>
                        </div>
                    </div>
                </div>
                
                <!-- 圖表容器 -->
                <div class="chart-container">
                    <div id="chart"></div>
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>正在載入圖表資料...</p>
                    </div>
                    
                    <!-- v5載入進度顯示 -->
                    <div id="v5-loading" class="backend-loading" style="display: block;">
                        <div class="backend-loading-content">
                            <h3>Lightweight Charts v5 系統啟動中...</h3>
                            <div class="progress-container">
                                <div id="v5-progress-bar" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="progress-info">
                                <span id="v5-progress-text">正在檢測版本...</span>
                                <span id="v5-progress-percent">0%</span>
                            </div>
                            <div id="v5-progress-steps" class="progress-steps">
                                <div class="step">準備載入 Lightweight Charts...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 版本顯示 -->
                    <div style="position: absolute; top: 10px; right: 10px; color: #666; font-size: 12px;" id="version-info">
                        載入中...
                    </div>
                </div>
                
                <!-- 狀態列 -->
                <div class="status-bar">
                    <div class="status-info">
                        <span id="candle-count">K線數量: --</span>
                        <span id="fvg-count">FVG數量: --</span>
                        <span id="time-range">時間範圍: --</span>
                        <span id="dst-status">時區狀態: --</span>
                        <span id="chart-version">圖表版本: --</span>
                    </div>
                    <div class="hover-info">
                        <span id="hover-data">將滑鼠移至圖表查看詳細資料</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 引入 Lightweight Charts v5.0.0 -->
    <script>
        // 更新進度條
        function updateProgress(percent, text, step) {
            // 更新新的載入進度條元素
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const currentStep = document.getElementById('current-step');
            const currentFile = document.getElementById('current-file');
            const loadingDetails = document.getElementById('loading-details');
            
            if (progressFill) progressFill.style.width = percent + '%';
            if (progressText) progressText.textContent = Math.round(percent) + '%';
            if (currentStep) currentStep.textContent = text;
            
            if (step && currentFile) {
                currentFile.textContent = step;
            }
            
            // 更新載入詳情
            if (step && loadingDetails) {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step-info';
                stepDiv.textContent = `► ${new Date().toLocaleTimeString()}: ${step}`;
                loadingDetails.appendChild(stepDiv);
                
                // 保持最新的5個步驟
                while (loadingDetails.children.length > 5) {
                    loadingDetails.removeChild(loadingDetails.firstChild);
                }
                loadingDetails.scrollTop = loadingDetails.scrollHeight;
            }
            
            // 舊的進度條相容性（如果存在）
            const oldProgressBar = document.getElementById('v5-progress-bar');
            const oldProgressText = document.getElementById('v5-progress-text');
            const oldProgressPercent = document.getElementById('v5-progress-percent');
            const oldProgressSteps = document.getElementById('v5-progress-steps');
            
            if (oldProgressBar) oldProgressBar.style.width = percent + '%';
            if (oldProgressText) oldProgressText.textContent = text;
            if (oldProgressPercent) oldProgressPercent.textContent = percent + '%';
            if (step && oldProgressSteps) {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.textContent = `[${new Date().toLocaleTimeString()}] ${step}`;
                oldProgressSteps.appendChild(stepDiv);
                oldProgressSteps.scrollTop = oldProgressSteps.scrollHeight;
            }
        }
        
        // 後端載入狀態監控
        function startBackendLoadingMonitor() {
            const elapsedTimeEl = document.getElementById('elapsed-time');
            const estimatedTimeEl = document.getElementById('estimated-time');
            const currentFileEl = document.getElementById('current-file');
            
            let startTime = Date.now();
            let hasShownBackendComplete = false;
            
            // 立即檢查一次，以防後端已經載入完成
            checkBackendStatus();
            
            const monitor = setInterval(checkBackendStatus, 1000);
            
            async function checkBackendStatus() {
                try {
                    const response = await fetch('http://127.0.0.1:5001/api/loading-status');
                    if (response.ok) {
                        const status = await response.json();
                        
                        // 更新經過時間
                        const elapsed = Math.floor((Date.now() - startTime) / 1000);
                        if (elapsedTimeEl) elapsedTimeEl.textContent = `已用時間: ${elapsed}s`;
                        
                        // 更新預估時間
                        if (status.estimated_time_remaining && estimatedTimeEl) {
                            estimatedTimeEl.textContent = `預估剩餘: ${status.estimated_time_remaining}s`;
                        } else if (estimatedTimeEl) {
                            estimatedTimeEl.textContent = `預估剩餘: --`;
                        }
                        
                        // 更新當前檔案
                        if (status.current_file && currentFileEl) {
                            currentFileEl.textContent = `正在處理: ${status.current_file}`;
                        }
                        
                        // 更新進度
                        if (status.progress !== undefined) {
                            updateProgress(status.progress, status.current_step || '載入中...', status.current_file || '');
                        }
                        
                        // 如果後端載入已完成
                        if (!status.is_loading && !hasShownBackendComplete) {
                            hasShownBackendComplete = true;
                            updateProgress(100, '後端載入完成，開始前端初始化...', '準備載入前端模組');
                            
                            // 繼續前端載入流程，不立即隱藏載入覆蓋層
                            console.log('後端載入完成，開始前端載入流程');
                            // 不要清除 monitor，讓前端流程控制載入覆蓋層的隱藏
                        }
                        
                        // 只有在前端也完成後才隱藏載入覆蓋層
                        // 這個邏輯將在前端載入完成時處理
                        
                    } else {
                        console.warn('無法獲取載入狀態');
                        // 如果無法獲取狀態，假設載入完成並繼續前端流程
                        if (!hasShownBackendComplete) {
                            hasShownBackendComplete = true;
                            updateProgress(50, '後端連接異常，繼續前端載入...', '準備載入前端模組');
                        }
                    }
                } catch (error) {
                    console.log('後端載入狀態監控錯誤:', error);
                    // 如果連接失敗，假設載入完成並繼續前端流程
                    if (!hasShownBackendComplete) {
                        hasShownBackendComplete = true;
                        updateProgress(50, '後端連接失敗，繼續前端載入...', '準備載入前端模組');
                    }
                }
            }
            
            // 返回監控控制器，讓前端載入完成時可以停止監控
            return {
                stop: () => clearInterval(monitor),
                isBackendComplete: () => hasShownBackendComplete
            };
        }

        // 檢查後端API狀態
        async function checkBackendStatus() {
            updateProgress(5, '檢查後端API狀態...', '正在連接後端服務');
            
            try {
                // 嘗試連接健康檢查端點
                const response = await fetch('http://127.0.0.1:5001/api/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const healthData = await response.json();
                    updateProgress(8, '後端API連接成功', `後端服務運行正常 - ${healthData.service}`);
                    return true;
                } else {
                    updateProgress(8, '後端API響應異常', `HTTP ${response.status} - 請檢查後端狀態`);
                    return false;
                }
            } catch (error) {
                updateProgress(8, '後端API連接失敗', '警告: 無法連接後端，將繼續前端載入');
                console.warn('後端檢查失敗，但繼續前端載入:', error);
                console.log('提示: 請確認後端服務已啟動 (執行: cd src/backend && python app.py)');
                return false; // 返回false但不阻止前端繼續
            }
        }

        // 檢查並載入 Lightweight Charts v5
        function loadLightweightCharts() {
            updateProgress(10, '開始載入 Lightweight Charts...', '檢測CDN可用性');
            
            return new Promise((resolve, reject) => {
                const cdnList = [
                    // 🚀 v5升級：優先載入Lightweight Charts v5
                    'https://unpkg.com/lightweight-charts@5.0.0/dist/lightweight-charts.standalone.production.js',
                    'https://cdn.jsdelivr.net/npm/lightweight-charts@5.0.0/dist/lightweight-charts.standalone.production.js',
                    // v4.1.3作為備選（向下兼容）
                    'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js'
                ];
                
                let currentIndex = 0;
                
                function tryLoad() {
                    if (currentIndex >= cdnList.length) {
                        reject(new Error('所有 CDN 都無法載入 Lightweight Charts'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    
                    script.onload = () => {
                        console.log('Lightweight Charts 載入成功:', cdnList[currentIndex]);
                        updateProgress(30, '檢測版本功能...', '圖表庫載入成功');
                        
                        // 檢查 API 是否可用
                        if (typeof LightweightCharts !== 'undefined' && 
                            typeof LightweightCharts.createChart === 'function') {
                            
                            // 檢測版本
                            let version = 'v4.x';
                            try {
                                // 檢查v5特有功能
                                if (typeof LightweightCharts.version === 'string') {
                                    console.log('LightweightCharts version:', LightweightCharts.version);
                                    if (LightweightCharts.version.startsWith('5.')) {
                                        version = 'v5.x';
                                    }
                                } else {
                                    // 檢查API差異
                                    const testChart = LightweightCharts.createChart(document.createElement('div'), {
                                        width: 100, height: 100
                                    });
                                    
                                    // v5檢測：檢查addCustomSeries和新API
                                    const hasCustomSeries = typeof testChart.addCustomSeries === 'function';
                                    const hasCandlestickSeries = typeof testChart.addCandlestickSeries === 'function';
                                    
                                    console.log('API檢測:', { hasCustomSeries, hasCandlestickSeries });
                                    
                                    if (hasCustomSeries) {
                                        version = 'v5.x';
                                    } else if (hasCandlestickSeries) {
                                        version = 'v4.x';
                                    }
                                }
                            } catch (e) {
                                console.warn('版本檢測警告:', e);
                                version = 'v4.x'; // 安全回退
                            }
                            
                            console.log('檢測到 Lightweight Charts 版本:', version);
                            document.getElementById('version-info').textContent = `LWC ${version}`;
                            updateProgress(50, `版本檢測完成: ${version}`, `確認使用 ${version}`);
                            
                            resolve(version);
                        } else {
                            console.warn('Lightweight Charts API 不完整');
                            currentIndex++;
                            tryLoad();
                        }
                    };
                    
                    script.onerror = () => {
                        console.warn('CDN 載入失敗:', cdnList[currentIndex]);
                        currentIndex++;
                        tryLoad();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoad();
            });
        }
        
        // 載入多個腳本的輔助函數
        // 舊的 loadModules 函數已被優化的並行載入系統取代

        // 主要啟動流程
        async function startSystem() {
            try {
                // 1. 檢查後端狀態
                const backendOk = await checkBackendStatus();
                if (!backendOk) {
                    updateProgress(8, '後端服務不可用', '警告: 後端可能需要重新啟動');
                    // 繼續載入前端，但提醒用戶
                }
                
                // 2. 載入圖表庫
                const version = await loadLightweightCharts();
                console.log('開始載入主程式... 版本:', version);
                
                return version;
            } catch (error) {
                console.error('系統啟動失敗:', error);
                updateProgress(0, '系統啟動失敗', `錯誤: ${error.message}`);
                throw error;
            }
        }

        // 單個腳本載入函數
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log(`載入成功: ${src}`);
                    resolve();
                };
                script.onerror = (error) => {
                    console.error(`載入失敗: ${src}`, error);
                    reject(new Error(`Script load failed: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // 並行載入多個模組的優化函數
        function loadModulesInParallel(version) {
            return new Promise((resolve, reject) => {
                console.log('開始並行載入模組策略...');
                
                // 階段1：關鍵依賴模組（必須按順序）
                const criticalModules = [
                    'logger.js',              // Logger系統 - 最最優先載入
                    'timestamp-utils.js',     // 時間戳工具 - 最優先載入
                    'data-validator.js',      // 數據驗證器 - 第二優先
                    'error-monitor.js',       // 錯誤監控器 - 第三優先
                    'candleAggregator.js',
                    'config.js'
                ];
                
                // 階段2：核心管理器模組（可並行）
                const coreModules = [
                    'chart-manager.js',
                    'data-manager.js'
                ];
                
                // 階段3：輔助模組（可並行）
                const auxiliaryModules = [
                    'playback-manager.js',
                    'event-manager.js'
                ];
                
                // 階段4：FVG渲染器（智能載入模式）
                
                // 檢測載入模式
                function detectLoadingMode() {
                    // 優先檢查URL參數
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlMode = urlParams.get('mode');
                    
                    if (urlMode === 'debug') return 'debug';
                    if (urlMode === 'dev' || urlMode === 'development') return 'development';
                    if (urlMode === 'production') return 'production';
                    
                    // 檢查本地存儲
                    const savedMode = localStorage.getItem('smartLoadingMode');
                    if (savedMode && ['production', 'debug', 'development'].includes(savedMode)) {
                        return savedMode;
                    }
                    
                    return 'production';  // 默認生產模式
                }
                
                // 根據模式選擇FVG渲染器
                function getFVGRenderersForMode(mode) {
                    const rendererConfigs = {
                        production: {
                            description: '生產模式 - 最佳性能',
                            renderers: [
                                'fvg-renderer-optimized.js'  // 只載入優化版本
                            ]
                        },
                        debug: {
                            description: '調試模式 - 包含調試工具',
                            renderers: [
                                'fvg-renderer-optimized.js',      // 主要渲染器
                                'fvg-renderer-ultra-minimal.js',  // 極簡調試版本
                                'fvg-renderer-safe.js'            // 安全調試版本
                            ]
                        },
                        development: {
                            description: '開發模式 - 完整功能',
                            renderers: [
                                'fvg-renderer-optimized.js',     // 高性能優化渲染器
                                'fvg-renderer-multiline.js',     // 多線條渲染器（備用）
                                'fvg-renderer-ultra-minimal.js', // 超級簡化渲染器
                                'fvg-renderer-safe.js',          // 安全渲染器
                                'fvg-renderer-fixed.js',         // 修復渲染器
                                'fvg-renderer-minimal.js'        // 極簡渲染器
                            ]
                        }
                    };
                    
                    return rendererConfigs[mode] || rendererConfigs.production;
                }
                
                const loadingMode = detectLoadingMode();
                const rendererConfig = getFVGRenderersForMode(loadingMode);
                const fvgRenderers = rendererConfig.renderers;
                
                // 智能日誌輸出 (檢查Logger是否可用)
                const smartLog = {
                    info: (msg, data) => {
                        if (window.log) {
                            window.log.loading(msg, data);
                        } else {
                            console.log(`📦 ${msg}`, data || '');
                        }
                    },
                    system: (msg, data) => {
                        if (window.log) {
                            window.log.system(msg, data);
                        } else {
                            console.log(`🔧 ${msg}`, data || '');
                        }
                    }
                };
                
                smartLog.system(`載入模式: ${loadingMode} (${rendererConfig.description})`);
                smartLog.info(`FVG渲染器: ${fvgRenderers.length} 個模組`, fvgRenderers);
                
                let currentStage = 1;
                const totalStages = 4;
                
                // 階段1：載入關鍵依賴（序列載入）
                smartLog.info('階段1: 載入關鍵依賴模組...');
                updateProgress(55, '載入關鍵依賴...', '載入 CandleAggregator 和 Config');
                
                loadModulesSequentially(criticalModules)
                    .then(() => {
                        smartLog.info('階段1完成，開始階段2: 並行載入核心模組...');
                        currentStage = 2;
                        updateProgress(65, '並行載入核心模組...', '載入 Chart 和 Data 管理器');
                        
                        // 階段2：並行載入核心模組
                        return Promise.all(coreModules.map(module => loadScript(module)));
                    })
                    .then(() => {
                        smartLog.info('階段2完成，開始階段3: 並行載入輔助模組...');
                        currentStage = 3;
                        updateProgress(75, '並行載入輔助模組...', '載入 Playback 和 Event 管理器');
                        
                        // 階段3：並行載入輔助模組
                        return Promise.all(auxiliaryModules.map(module => loadScript(module)));
                    })
                    .then(() => {
                        smartLog.info('階段3完成，開始階段4: 載入FVG渲染器...');
                        currentStage = 4;
                        updateProgress(80, '載入FVG渲染器...', '載入簡單和多線條渲染器');
                        
                        // 階段4：載入FVG渲染器（簡單+多線條版本）
                        return Promise.all(fvgRenderers.map(renderer => loadScript(renderer)));
                    })
                    .then(() => {
                        console.log('所有模組載入完成！');
                        updateProgress(82, '模組載入完成', '所有核心模組載入成功');
                        resolve();
                    })
                    .catch(error => {
                        console.error('模組載入失敗:', error);
                        updateProgress(60, '模組載入失敗', `錯誤: ${error.message}`);
                        reject(error);
                    });
            });
        }

        // 序列載入模組函數
        function loadModulesSequentially(modules) {
            return modules.reduce((promise, module) => {
                return promise.then(() => loadScript(module));
            }, Promise.resolve());
        }

        // 立即啟動，不等待DOM載入（腳本在body末尾，DOM已經存在）
        console.log('開始系統初始化');
        
        // 全域變數來存儲 backendMonitor
        let globalBackendMonitor = null;
        
        // 立即檢查後端狀態並顯示進度
        async function initializeSystem() {
            try {
                const response = await fetch('http://127.0.0.1:5001/api/loading-status');
                if (response.ok) {
                    const status = await response.json();
                    console.log('後端狀態:', status);
                    
                    if (!status.is_loading) {
                        // 後端已完成，直接顯示完成狀態
                        updateProgress(100, '後端載入完成，開始前端初始化...', '開始載入前端模組');
                        console.log('後端已完成載入，開始前端流程');
                    } else {
                        // 後端還在載入，啟動監控
                        updateProgress(status.progress, status.current_step, status.current_file);
                    }
                } else {
                    console.warn('無法連接後端，繼續前端載入');
                    updateProgress(50, '後端連接異常，繼續前端載入...', '準備載入前端模組');
                }
            } catch (error) {
                console.log('後端檢查失敗，繼續前端載入:', error);
                updateProgress(50, '後端檢查失敗，繼續前端載入...', '準備載入前端模組');
            }
            
            // 啟動後端載入監控（如果需要）
            globalBackendMonitor = startBackendLoadingMonitor();
            
            // 優化版並行載入系統
            return startSystem();
        }
        
        // 啟動系統初始化
        initializeSystem().then((detectedVersion) => {
            console.log('Lightweight Charts 版本確認:', detectedVersion);
            updateProgress(50, '開始並行載入模組...', '準備載入核心模組');
            
            // 並行載入策略：關鍵模組並行載入
            return loadModulesInParallel(detectedVersion).then(() => detectedVersion);
        }).then((version) => {
                console.log('所有模組載入完成，開始載入主程式');
                updateProgress(85, '載入主程式...', '所有模組載入完成');
                
                // 最後載入主程式
                return loadScript('script-v2.js').then(() => version);
            })
            .then((version) => {
                console.log('script-v2.js 載入成功');
                updateProgress(95, '初始化系統...', '主程式載入完成');
                
                // 監聽JavaScript錯誤
                window.addEventListener('error', (event) => {
                    console.error('JavaScript錯誤:', event.error);
                    const errorMessage = event.error && event.error.message ? event.error.message : '未知錯誤';
                    updateProgress(95, '系統初始化錯誤', `錯誤: ${errorMessage}`);
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('Promise錯誤:', event.reason);
                    updateProgress(95, '系統初始化錯誤', `Promise錯誤: ${event.reason}`);
                });
                
                // 詳細監控系統初始化
                let initCheckCount = 0;
                const maxChecks = 20; // 最多檢查20次 (10秒)
                
                const initChecker = setInterval(() => {
                    initCheckCount++;
                    
                    console.log(`[初始化檢查 ${initCheckCount}/${maxChecks}] window.app:`, !!window.app);
                    if (window.app) {
                        console.log('window.app.chart:', !!window.app.chart);
                        console.log('window.app.chartManager:', !!window.app.chartManager);
                        console.log('window.app.error:', window.app.error);
                        if (window.app.error) {
                            console.log('window.app.errorMessage:', window.app.errorMessage);
                        }
                    }
                    
                    if (window.app && window.app.chart && !window.app.error) {
                        // 成功初始化
                        clearInterval(initChecker);
                        const chartVersion = version;
                        document.getElementById('chart-version').textContent = `圖表: ${chartVersion}`;
                        updateProgress(100, '系統就緒！', '交易圖表系統啟動完成');
                        
                        // 初始化FVG多線條渲染器控制項目
                        initializeFVGControls();
                        
                        // 停止後端監控並隱藏載入覆蓋層
                        if (globalBackendMonitor) {
                            globalBackendMonitor.stop();
                        }
                        setTimeout(() => {
                            const loadingOverlay = document.getElementById('loading-overlay');
                            if (loadingOverlay) {
                                loadingOverlay.style.opacity = '0';
                                setTimeout(() => {
                                    loadingOverlay.style.display = 'none';
                                }, 500);
                            }
                            // 舊的進度條也隱藏
                            const v5Loading = document.getElementById('v5-loading');
                            if (v5Loading) {
                                v5Loading.style.display = 'none';
                            }
                        }, 2000);
                        
                    } else if (window.app && window.app.error) {
                        // 初始化失敗，但有錯誤信息
                        clearInterval(initChecker);
                        updateProgress(90, '系統初始化失敗', `錯誤: ${window.app.errorMessage}`);
                        console.error('系統初始化失敗:', window.app.errorMessage);
                        
                    } else if (initCheckCount >= maxChecks) {
                        // 超時失敗
                        clearInterval(initChecker);
                        updateProgress(90, '系統初始化超時', '請檢查控制台錯誤訊息');
                        console.error('系統初始化超時 - 請檢查是否有JavaScript錯誤');
                        
                    } else {
                        // 更新等待狀態
                        const waitMsg = `等待系統初始化 (${initCheckCount}/${maxChecks})`;
                        updateProgress(90 + (initCheckCount / maxChecks) * 8, waitMsg, `檢查應用程式物件...`);
                    }
                }, 500); // 每500ms檢查一次
            })
            .catch(error => {
                console.error('圖表庫載入失敗:', error);
                alert('圖表庫載入失敗，請檢查網路連線或嘗試重新整理頁面。');
            });
            
        // CandleAggregator腳本初始化部分
        const aggregatorScript = document.createElement('script');
        aggregatorScript.src = 'candleAggregator.js';
        aggregatorScript.onload = () => {
            console.log('CandleAggregator 載入完成');
        };
        
        aggregatorScript.onerror = () => {
            console.error('CandleAggregator 載入失敗');
            alert('系統載入失敗，請重新整理頁面。');
        };
        
        document.head.appendChild(aggregatorScript);
            
        // ========== FVG 多線條渲染器控制項目初始化 ==========
        
        function initializeFVGControls() {
            console.log('🎛️ 初始化FVG控制項目');
            
            try {
                // 獲取控制項目元素
                const fvgCheckbox = document.getElementById('fvg-checkbox');
                const fvgMarkersCheckbox = document.getElementById('fvg-markers-checkbox');
                const fvgClearedCheckbox = document.getElementById('fvg-cleared-checkbox');
                const fvgPerformanceMode = document.getElementById('fvg-performance-mode');
                const fvgPrimitivesCount = document.getElementById('fvg-primitives-count');
                const fvgMarkersCount = document.getElementById('fvg-markers-count');
                
                // 檢查必要元素是否存在
                if (!fvgCheckbox) {
                    console.error('❌ 主要FVG控制項目未找到');
                    return;
                }
                
                // 設置初始狀態
                const config = window.CONFIG?.FVG || {};
                if (fvgMarkersCheckbox) fvgMarkersCheckbox.checked = config.DEFAULT_SHOW_MARKERS || false;
                if (fvgClearedCheckbox) fvgClearedCheckbox.checked = config.DEFAULT_SHOW_CLEARED || false;
                
                // 主要FVG開關事件
                fvgCheckbox.addEventListener('change', function(e) {
                    console.log(`🎛️ FVG顯示: ${e.target.checked ? '開啟' : '關閉'}`);
                    
                    if (window.app?.chartManager?.fvgRenderer) {
                        window.app.chartManager.fvgRenderer.toggle();
                        if (window.app.dataManager?.currentData?.fvgs) {
                            window.app.chartManager.fvgRenderer.render(
                                window.app.dataManager.currentData.fvgs,
                                window.app.dataManager.currentTimeframe
                            );
                        }
                        updateFVGStats();
                    }
                });
                
                // FVG標記開關事件
                if (fvgMarkersCheckbox) {
                    fvgMarkersCheckbox.addEventListener('change', function(e) {
                        console.log(`🏷️ FVG標記: ${e.target.checked ? '開啟' : '關閉'}`);
                        
                        if (window.app?.chartManager?.fvgRenderer) {
                            window.app.chartManager.fvgRenderer.toggleMarkers();
                            if (window.app.dataManager?.currentData?.fvgs) {
                                window.app.chartManager.fvgRenderer.render(
                                    window.app.dataManager.currentData.fvgs,
                                    window.app.dataManager.currentTimeframe
                                );
                            }
                            updateFVGStats();
                        }
                    });
                }
                
                // 已清除FVG開關事件
                if (fvgClearedCheckbox) {
                    fvgClearedCheckbox.addEventListener('change', function(e) {
                        console.log(`👻 已清除FVG: ${e.target.checked ? '開啟' : '關閉'}`);
                        
                        if (window.app?.chartManager?.fvgRenderer) {
                            window.app.chartManager.fvgRenderer.toggleClearedFVGs();
                            if (window.app.dataManager?.currentData?.fvgs) {
                                window.app.chartManager.fvgRenderer.render(
                                    window.app.dataManager.currentData.fvgs,
                                    window.app.dataManager.currentTimeframe
                                );
                            }
                            updateFVGStats();
                        }
                    });
                }
                
                // 性能模式選擇事件
                if (fvgPerformanceMode) {
                    fvgPerformanceMode.addEventListener('change', function(e) {
                        const mode = e.target.value;
                        console.log(`⚙️ FVG性能模式: ${mode}`);
                        
                        if (window.app?.chartManager?.fvgRenderer) {
                            const modes = { 
                                high: 130, 
                                balanced: 60, 
                                performance: 20 
                            };
                            
                            window.app.chartManager.fvgRenderer.setMaxLines(modes[mode]);
                            
                            // 重新渲染以應用新設置
                            if (window.app.dataManager?.currentData?.fvgs) {
                                window.app.chartManager.fvgRenderer.render(
                                    window.app.dataManager.currentData.fvgs,
                                    window.app.dataManager.currentTimeframe
                                );
                            }
                            updateFVGStats();
                        }
                    });
                }
                
                // 更新統計信息函數
                function updateFVGStats() {
                    if (window.app?.chartManager?.fvgRenderer && fvgPrimitivesCount && fvgMarkersCount) {
                        const stats = window.app.chartManager.fvgRenderer.getStats();
                        fvgPrimitivesCount.textContent = stats.totalPrimitives || '0';
                        fvgMarkersCount.textContent = stats.totalMarkers || '0';
                    }
                }
                
                // 定時更新統計信息
                setInterval(updateFVGStats, 2000);
                
                // 初始統計更新
                setTimeout(updateFVGStats, 1000);
                
                console.log('✅ FVG控制項目初始化完成');
                
            } catch (error) {
                console.error('❌ FVG控制項目初始化失敗:', error);
            }
        }
        
        // ========== 輔助函數 ==========
        
        // 刷新FVG顯示
        function refreshFVGDisplay() {
            if (window.app?.chartManager?.fvgRenderer && window.app.dataManager?.currentData?.fvgs) {
                console.log('🔄 刷新FVG顯示');
                window.app.chartManager.fvgRenderer.render(
                    window.app.dataManager.currentData.fvgs,
                    window.app.dataManager.currentTimeframe
                );
            }
        }
        
        // 暴露到全域以供調試
        window.refreshFVGDisplay = refreshFVGDisplay;
        
        // ========== FVG完整診斷系統 ==========
        
        window.runFullFVGDiagnostics = function() {
            console.group('🔍 FVG系統完整診斷');
            
            console.log('📊 第1步: 系統架構檢查');
            console.log('   - chartManager存在:', !!window.app?.chartManager);
            console.log('   - dataManager存在:', !!window.app?.dataManager);
            console.log('   - FVGRendererMultiline類可用:', typeof window.FVGRendererMultiline);
            
            if (window.app?.chartManager) {
                const chartManager = window.app.chartManager;
                console.log('   - FVG渲染器已初始化:', !!chartManager.fvgRenderer);
                console.log('   - 渲染器類型:', chartManager.fvgRenderer?.constructor.name);
                console.log('   - 使用優化渲染器:', chartManager.isUsingOptimizedRenderer?.() || false);
            }
            
            console.log('📊 第2步: 數據狀態檢查');
            
            // 檢查多個可能的數據源
            let data = window.app?.dataManager?.currentData || window.currentData;
            console.log('   - dataManager.currentData存在:', !!window.app?.dataManager?.currentData);
            console.log('   - window.currentData存在:', !!window.currentData);
            
            if (data) {
                console.log('   - 當前數據存在:', !!data);
                console.log('   - 日期:', data.date);
                console.log('   - K線數據:', data.data ? data.data.length + '根' : '無');
                console.log('   - FVG數據:', data.fvgs ? data.fvgs.length + '個' : '無');
                
                if (data.fvgs && data.fvgs.length > 0) {
                    const valid = data.fvgs.filter(f => f.status === 'valid');
                    const cleared = data.fvgs.filter(f => f.status === 'cleared');
                    console.log('   - 有效FVG:', valid.length + '個');
                    console.log('   - 已清除FVG:', cleared.length + '個');
                    
                    const sample = data.fvgs[0];
                    console.log('   - 樣本FVG完整性:');
                    console.log('     * type:', sample.type);
                    console.log('     * status:', sample.status);
                    console.log('     * topPrice:', sample.topPrice);
                    console.log('     * bottomPrice:', sample.bottomPrice);
                    console.log('     * startTime:', sample.startTime);
                    console.log('     * endTime:', sample.endTime);
                } else {
                    console.warn('❌ 沒有FVG數據');
                }
            } else {
                console.warn('❌ 沒有當前數據');
            }
            
            console.log('📊 第3步: 控制項狀態檢查');
            const fvgCheckbox = document.getElementById('fvg-checkbox');
            const fvgClearedCheckbox = document.getElementById('fvg-cleared-checkbox');
            const fvgMarkersCheckbox = document.getElementById('fvg-markers-checkbox');
            
            console.log('   - 主FVG複選框:', fvgCheckbox ? (fvgCheckbox.checked ? '✅已勾選' : '❌未勾選') : '❌不存在');
            console.log('   - 已清除FVG複選框:', fvgClearedCheckbox ? (fvgClearedCheckbox.checked ? '✅已勾選' : '❌未勾選') : '❌不存在');
            console.log('   - FVG標記複選框:', fvgMarkersCheckbox ? (fvgMarkersCheckbox.checked ? '✅已勾選' : '❌未勾選') : '❌不存在');
            
            console.log('📊 第4步: 渲染器詳細診斷');
            if (window.app?.chartManager?.fvgRenderer && typeof window.diagnoseFVGRenderer === 'function') {
                console.log('   - 運行渲染器內部診斷...');
                const rendererDiag = window.diagnoseFVGRenderer();
                console.log('   - 渲染器診斷結果:', rendererDiag);
            } else {
                console.warn('   - 渲染器診斷不可用');
            }
            
            console.log('📊 第5步: 手動渲染測試');
            if (window.app?.chartManager?.fvgRenderer && window.app?.dataManager?.currentData?.fvgs) {
                console.log('   - 嘗試手動觸發FVG渲染...');
                try {
                    window.app.chartManager.fvgRenderer.render(
                        window.app.dataManager.currentData.fvgs, 
                        window.app.dataManager.currentTimeframe || 'M15'
                    );
                    console.log('   ✅ 手動渲染命令已執行');
                } catch (e) {
                    console.error('   ❌ 手動渲染失敗:', e);
                }
            }
            
            console.log('📊 診斷建議:');
            const suggestions = [];
            
            if (!window.app?.chartManager?.fvgRenderer) {
                suggestions.push('重新載入頁面以初始化FVG渲染器');
            }
            if (!window.app?.dataManager?.currentData?.fvgs) {
                suggestions.push('點擊"隨機日期"按鈕載入包含FVG的數據');
            }
            if (!fvgCheckbox?.checked) {
                suggestions.push('勾選左側面板的"Fair Value Gap (FVG)"複選框');
            }
            if (!fvgClearedCheckbox?.checked) {
                suggestions.push('勾選"顯示已清除FVG"以查看更多FVG');
            }
            
            if (suggestions.length === 0) {
                console.log('   ✅ 系統狀態看起來正常，FVG應該可以正常顯示');
                console.log('   📌 如果仍看不到FVG，請檢查圖表縮放級別或時間範圍');
            } else {
                suggestions.forEach((suggestion, index) => {
                    console.log(`   ${index + 1}. ${suggestion}`);
                });
            }
            
            console.groupEnd();
        };
        
        // 快速FVG狀態檢查函數
        window.quickFVGCheck = function() {
            console.log('🚀 快速FVG狀態檢查:');
            console.log('   渲染器:', !!window.app?.chartManager?.fvgRenderer ? '✅' : '❌');
            console.log('   數據:', !!window.app?.dataManager?.currentData?.fvgs ? '✅' : '❌');
            console.log('   本地數據:', !!window.currentData?.fvgs ? '✅' : '❌');
            console.log('   複選框:', !!document.getElementById('fvg-checkbox')?.checked ? '✅' : '❌');
            console.log('   圖元數量:', window.app?.chartManager?.fvgRenderer?.fvgPrimitives?.length || 0);
        };
        
        // 手動載入測試數據函數
        window.testLoadRandomData = async function() {
            console.log('🧪 手動載入測試數據...');
            try {
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    console.log('   點擊隨機日期按鈕...');
                    refreshBtn.click();
                    
                    // 等待3秒後檢查結果
                    setTimeout(() => {
                        console.log('📊 載入結果檢查:');
                        console.log('   全域currentData:', !!window.currentData);
                        console.log('   FVG數據:', window.currentData?.fvgs?.length || 0);
                        if (window.currentData?.fvgs) {
                            const valid = window.currentData.fvgs.filter(f => f.status === 'valid');
                            const cleared = window.currentData.fvgs.filter(f => f.status === 'cleared');
                            console.log('   有效FVG:', valid.length);
                            console.log('   已清除FVG:', cleared.length);
                        }
                        console.log('   圖元數量:', window.app?.chartManager?.fvgRenderer?.fvgPrimitives?.length || 0);
                    }, 3000);
                } else {
                    console.error('❌ 找不到刷新按鈕');
                }
            } catch (e) {
                console.error('❌ 測試載入失敗:', e);
            }
        };
        
        // ===== 智能載入模式切換功能 =====
        
        // 模式切換功能
        window.switchLoadingMode = function(mode) {
            if (!['production', 'debug', 'development'].includes(mode)) {
                console.error('無效的載入模式:', mode);
                return;
            }
            
            console.log(`🔄 切換載入模式到: ${mode}`);
            
            // 保存到本地存儲
            localStorage.setItem('smartLoadingMode', mode);
            
            // 更新URL參數
            const url = new URL(window.location);
            url.searchParams.set('mode', mode);
            
            // 重新載入頁面以應用新模式
            window.location = url.toString();
        };
        
        // 更新模式切換器UI
        function updateModeUI() {
            const currentMode = detectLoadingMode();
            
            // 更新當前模式顯示
            const currentModeElement = document.getElementById('current-mode');
            if (currentModeElement) {
                currentModeElement.textContent = currentMode;
            }
            
            // 更新按鈕狀態
            document.querySelectorAll('.mode-switcher button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeButton = document.getElementById(`mode-${currentMode}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            console.log(`🎯 當前載入模式: ${currentMode}`);
        }
        
        // 在頁面載入完成後更新UI
        document.addEventListener('DOMContentLoaded', function() {
            // 稍微延遲以確保模式檢測邏輯已執行
            setTimeout(updateModeUI, 100);
        });
        
        // 如果DOM已經載入完成，立即更新UI
        if (document.readyState !== 'loading') {
            setTimeout(updateModeUI, 100);
        }
        
    </script>
</body>
</html>