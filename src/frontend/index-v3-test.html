<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“åœ–è¡¨ç³»çµ± - V3è¼‰å…¥æ¸¬è©¦ç‰ˆ</title>
    
    <!-- è¼‰å…¥æ–°çš„è¼‰å…¥é…ç½® -->
    <script src="loading-config.js"></script>
    
    <link rel="stylesheet" href="style-v2.css">
    
    <style>
        /* æ¸¬è©¦ç‰ˆæœ¬æ¨™è­˜ */
        .test-banner {
            position: fixed;
            top: 0;
            right: 0;
            background: #ff6b35;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            z-index: 10000;
            border-radius: 0 0 0 8px;
        }
        
        /* è¼‰å…¥æ¨¡å¼åˆ‡æ›å™¨ */
        .mode-switcher {
            position: fixed;
            top: 40px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 9999;
            font-size: 12px;
        }
        
        .mode-switcher button {
            margin: 2px;
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .mode-switcher button.active {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <!-- æ¸¬è©¦ç‰ˆæœ¬æ¨™è­˜ -->
    <div class="test-banner">V3è¼‰å…¥ç³»çµ±æ¸¬è©¦ç‰ˆ</div>
    
    <!-- è¼‰å…¥æ¨¡å¼åˆ‡æ›å™¨ -->
    <div class="mode-switcher">
        <div>è¼‰å…¥æ¨¡å¼:</div>
        <button onclick="switchMode('production')" id="mode-production">ç”Ÿç”¢</button>
        <button onclick="switchMode('debug')" id="mode-debug">èª¿è©¦</button>
        <button onclick="switchMode('development')" id="mode-development">é–‹ç™¼</button>
        <br>
        <small>ç•¶å‰: <span id="current-mode">auto</span></small>
    </div>

    <!-- è¼‰å…¥é€²åº¦è¦†è“‹å±¤ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-container">
            <div class="loading-header">
                <h2>äº¤æ˜“åœ–è¡¨ç³»çµ±è¼‰å…¥ä¸­ (V3)</h2>
                <div class="loading-subtitle">ä½¿ç”¨æ–°çš„æ™ºèƒ½è¼‰å…¥ç³»çµ±...</div>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div id="progress-text" class="progress-text">0%</div>
                </div>
                
                <div id="status-text" class="current-step">åˆå§‹åŒ–è¼‰å…¥ç³»çµ±...</div>
                <div id="detail-text" class="current-file">æº–å‚™è¼‰å…¥æ ¸å¿ƒæ¨¡çµ„</div>
                
                <div class="details-section">
                    <div id="time-info" class="time-info">
                        <span id="elapsed-time">å·²ç”¨æ™‚é–“: 0s</span>
                        <span id="module-count">æ¨¡çµ„: 0/0</span>
                    </div>
                    <div id="loading-details" class="loading-details"></div>
                </div>
            </div>
            
            <!-- è¼‰å…¥çµ±è¨ˆ (èª¿è©¦ç”¨) -->
            <div id="loading-stats" style="margin-top: 20px; font-size: 12px; color: #666; display: none;">
                <details>
                    <summary>è¼‰å…¥çµ±è¨ˆè©³æƒ…</summary>
                    <div id="stats-content"></div>
                </details>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦ä½ˆå±€å®¹å™¨ (æ²¿ç”¨ç¾æœ‰çµæ§‹) -->
    <div class="main-layout">
        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div class="left-panel">
            <div class="control-section">
                <h3>åœ–è¡¨æ§åˆ¶</h3>
                
                <!-- æ™‚é–“æ¡†æ¶é¸æ“‡ -->
                <div class="control-group">
                    <label for="timeframe-select">æ™‚é–“æ¡†æ¶:</label>
                    <select id="timeframe-select" class="timeframe-selector">
                        <option value="M15" selected>15åˆ†é˜</option>
                        <option value="M30">30åˆ†é˜</option>
                        <option value="H1">1å°æ™‚</option>
                        <option value="H4">4å°æ™‚</option>
                        <option value="D1">æ—¥ç·š</option>
                    </select>
                </div>
                
                <!-- æ—¥æœŸé¸æ“‡ -->
                <div class="control-group">
                    <label for="date-picker">é¸æ“‡æ—¥æœŸ:</label>
                    <input type="date" id="date-picker" class="date-picker">
                    <button id="random-date-btn" class="random-btn">éš¨æ©Ÿæ—¥æœŸ</button>
                </div>
                
                <!-- FVGæ§åˆ¶ -->
                <div class="control-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="fvg-toggle" checked>
                        <span class="checkmark"></span>
                        é¡¯ç¤ºFVG
                    </label>
                    <div id="fvg-stats" class="fvg-stats"></div>
                </div>
                
                <!-- æ’­æ”¾æ§åˆ¶ -->
                <div class="control-group playback-controls">
                    <h4>å¸‚å ´æ’­æ”¾</h4>
                    <div class="playback-buttons">
                        <button id="play-btn" class="playback-btn">â–¶ï¸</button>
                        <button id="pause-btn" class="playback-btn">â¸ï¸</button>
                        <button id="stop-btn" class="playback-btn">â¹ï¸</button>
                    </div>
                    <div class="speed-control">
                        <label>æ’­æ”¾é€Ÿåº¦:</label>
                        <select id="playback-speed">
                            <option value="1">1x</option>
                            <option value="2" selected>2x</option>
                            <option value="5">5x</option>
                            <option value="10">10x</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦åœ–è¡¨å€åŸŸ -->
        <div class="chart-area">
            <div class="chart-header">
                <h1 id="chart-title">äº¤æ˜“åœ–è¡¨ç³»çµ±</h1>
                <div id="chart-info" class="chart-info">
                    <span id="current-date">è¼‰å…¥ä¸­...</span>
                    <span id="candle-count">Kç·š: --</span>
                    <span id="fvg-count">FVG: --</span>
                </div>
            </div>
            <div id="chart-container" class="chart-container"></div>
        </div>

        <!-- å³å´ä¿¡æ¯é¢æ¿ -->
        <div class="right-panel">
            <div class="info-section">
                <h3>ç³»çµ±ç‹€æ…‹</h3>
                <div id="system-status" class="system-status">
                    <div class="status-item">
                        <span class="status-label">å¾Œç«¯:</span>
                        <span id="backend-status" class="status-value">æª¢æŸ¥ä¸­...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">åœ–è¡¨:</span>
                        <span id="chart-status" class="status-value">æœªåˆå§‹åŒ–</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æ•¸æ“š:</span>
                        <span id="data-status" class="status-value">æœªè¼‰å…¥</span>
                    </div>
                </div>
            </div>
            
            <!-- FVGè©³ç´°ä¿¡æ¯ -->
            <div class="info-section">
                <h3>FVGä¿¡æ¯</h3>
                <div id="fvg-details" class="fvg-details">
                    <div>ç­‰å¾…æ•¸æ“šè¼‰å…¥...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- V3è¼‰å…¥ç³»çµ±è…³æœ¬ -->
    <script>
        // è¼‰å…¥ç³»çµ±æ§åˆ¶å™¨
        class V3LoadingController {
            constructor() {
                this.startTime = Date.now();
                this.loadingManager = null;
                this.currentMode = this.detectMode();
                this.updateModeUI();
            }
            
            detectMode() {
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                if (mode && ['production', 'debug', 'development'].includes(mode)) {
                    return mode;
                }
                
                const saved = localStorage.getItem('v3LoadingMode');
                if (saved && ['production', 'debug', 'development'].includes(saved)) {
                    return saved;
                }
                
                // è‡ªå‹•æª¢æ¸¬
                return window.LoadingConfig.detectRecommendedMode();
            }
            
            updateModeUI() {
                document.getElementById('current-mode').textContent = this.currentMode;
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.mode-switcher button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`mode-${this.currentMode}`).classList.add('active');
                
                // èª¿è©¦æ¨¡å¼é¡¯ç¤ºçµ±è¨ˆ
                if (this.currentMode !== 'production') {
                    document.getElementById('loading-stats').style.display = 'block';
                }
            }
            
            async start() {
                try {
                    console.log(`ğŸš€ V3è¼‰å…¥ç³»çµ±å•Ÿå‹• (æ¨¡å¼: ${this.currentMode})`);
                    this.updateElapsedTime();
                    
                    // è¼‰å…¥è¼‰å…¥ç®¡ç†å™¨
                    await this.loadScript('loading-manager-v2.js');
                    
                    // å‰µå»ºç®¡ç†å™¨å¯¦ä¾‹
                    this.loadingManager = new LoadingManagerV2();
                    window.loadingManager = this.loadingManager;
                    
                    // è¨­ç½®è¼‰å…¥æ¨¡å¼
                    this.loadingManager.setMode(this.currentMode);
                    
                    // åŸ·è¡Œè¼‰å…¥
                    const result = await this.loadingManager.loadAll();
                    
                    if (result.success) {
                        console.log('âœ… V3è¼‰å…¥ç³»çµ±æˆåŠŸ');
                        this.showStats(result);
                        this.hideLoadingScreen();
                    } else {
                        console.error('âŒ V3è¼‰å…¥å¤±æ•—:', result.error);
                        this.showError(result.error, result);
                    }
                    
                } catch (error) {
                    console.error('ğŸ’¥ V3è¼‰å…¥æ§åˆ¶å™¨å¤±æ•—:', error);
                    this.showError(error.message);
                }
            }
            
            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = () => reject(new Error(`è¼‰å…¥å¤±æ•—: ${src}`));
                    document.head.appendChild(script);
                });
            }
            
            showStats(result) {
                const totalTime = Date.now() - this.startTime;
                const stats = {
                    mode: result.mode,
                    totalTime: `${totalTime}ms`,
                    moduleCount: `${result.loadedModules.length}/${result.loadedModules.length + result.failedModules.length}`,
                    loadedModules: result.loadedModules,
                    failedModules: result.failedModules
                };
                
                document.getElementById('stats-content').innerHTML = `
                    <div><strong>è¼‰å…¥æ¨¡å¼:</strong> ${stats.mode}</div>
                    <div><strong>ç¸½æ™‚é–“:</strong> ${stats.totalTime}</div>
                    <div><strong>æ¨¡çµ„æ•¸é‡:</strong> ${stats.moduleCount}</div>
                    <div><strong>æˆåŠŸè¼‰å…¥:</strong> ${stats.loadedModules.join(', ')}</div>
                    ${stats.failedModules.length > 0 ? `<div><strong>å¤±æ•—æ¨¡çµ„:</strong> ${stats.failedModules.join(', ')}</div>` : ''}
                `;
            }
            
            updateElapsedTime() {
                const update = () => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const element = document.getElementById('elapsed-time');
                    if (element) {
                        element.textContent = `å·²ç”¨æ™‚é–“: ${elapsed}s`;
                    }
                };
                
                update();
                this.timeInterval = setInterval(update, 1000);
            }
            
            hideLoadingScreen() {
                clearInterval(this.timeInterval);
                document.getElementById('loading-overlay').style.display = 'none';
                
                // è§¸ç™¼ç³»çµ±å°±ç·’äº‹ä»¶
                window.dispatchEvent(new CustomEvent('v3SystemReady'));
            }
            
            showError(message, result = null) {
                clearInterval(this.timeInterval);
                document.getElementById('status-text').textContent = 'è¼‰å…¥å¤±æ•—';
                document.getElementById('detail-text').textContent = message;
                
                if (result) {
                    this.showStats(result);
                }
            }
        }
        
        // æ¨¡å¼åˆ‡æ›åŠŸèƒ½
        function switchMode(mode) {
            localStorage.setItem('v3LoadingMode', mode);
            const url = new URL(window.location);
            url.searchParams.set('mode', mode);
            window.location = url.toString();
        }
        
        // å•Ÿå‹•V3è¼‰å…¥ç³»çµ±
        const v3Controller = new V3LoadingController();
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => v3Controller.start());
        } else {
            v3Controller.start();
        }
        
        // ç›£è½ç³»çµ±å°±ç·’äº‹ä»¶
        window.addEventListener('v3SystemReady', () => {
            console.log('ğŸ‰ V3ç³»çµ±å®Œå…¨å°±ç·’');
            
            // è§¸ç™¼åŸæœ‰çš„ç³»çµ±åˆå§‹åŒ– (å¦‚æœå­˜åœ¨)
            if (window.initializeSystem) {
                window.initializeSystem();
            }
        });
    </script>
</body>
</html>