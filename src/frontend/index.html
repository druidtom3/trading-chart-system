<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易圖表系統 - 紐約開盤前分析</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 指標選擇側邊欄 -->
    <div id="indicators-sidebar" class="indicators-sidebar">
        <div class="sidebar-header">
            <h3>技術指標</h3>
            <button id="close-sidebar-btn" class="close-btn">&times;</button>
        </div>
        
        <div class="sidebar-content">
            <!-- 價格動作指標 -->
            <div class="indicator-category">
                <h4>價格動作</h4>
                <div class="indicator-list">
                    <label class="indicator-item">
                        <input type="checkbox" id="fvg-checkbox" checked>
                        <span class="indicator-name">Fair Value Gap (FVG)</span>
                        <button class="settings-btn" data-indicator="fvg" title="設定參數">⚙</button>
                    </label>
                    
                    <label class="indicator-item">
                        <input type="checkbox" id="sr-checkbox">
                        <span class="indicator-name">支撐阻力位</span>
                        <button class="settings-btn" data-indicator="sr" title="設定參數">⚙</button>
                    </label>
                </div>
            </div>
            
            <!-- 移動平均線 -->
            <div class="indicator-category">
                <h4>移動平均線</h4>
                <div class="indicator-list">
                    <label class="indicator-item">
                        <input type="checkbox" id="sma-checkbox">
                        <span class="indicator-name">簡單移動平均 (SMA)</span>
                        <button class="settings-btn" data-indicator="sma" title="設定參數">⚙</button>
                    </label>
                    
                    <label class="indicator-item">
                        <input type="checkbox" id="ema-checkbox">
                        <span class="indicator-name">指數移動平均 (EMA)</span>
                        <button class="settings-btn" data-indicator="ema" title="設定參數">⚙</button>
                    </label>
                </div>
            </div>
            
            <!-- 震盪指標 -->
            <div class="indicator-category">
                <h4>震盪指標</h4>
                <div class="indicator-list">
                    <label class="indicator-item">
                        <input type="checkbox" id="rsi-checkbox">
                        <span class="indicator-name">相對強弱指數 (RSI)</span>
                        <button class="settings-btn" data-indicator="rsi" title="設定參數">⚙</button>
                    </label>
                    
                    <label class="indicator-item">
                        <input type="checkbox" id="macd-checkbox">
                        <span class="indicator-name">MACD</span>
                        <button class="settings-btn" data-indicator="macd" title="設定參數">⚙</button>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 背景遮罩 -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div class="container">
        <!-- 頂部控制面板 -->
        <div class="control-panel">
            <div class="info-section">
                <h1>交易圖表系統</h1>
                <div class="date-info">
                    <span id="current-date">載入中...</span>
                    <span id="market-info">載入中...</span>
                    <span id="holiday-info" class="holiday-badge" style="display: none;">美國假日</span>
                </div>
            </div>
            
            <div class="controls">
                <!-- 漢堡選單按鈕 -->
                <button id="indicators-menu-btn" class="btn btn-menu" title="技術指標">
                    <span class="hamburger-icon">☰</span>
                </button>
                
                <!-- 操作按鈕 -->
                <div class="action-buttons">
                    <button id="refresh-btn" class="btn btn-primary">隨機日期</button>
                    <button id="reset-zoom-btn" class="btn btn-secondary">重置縮放</button>
                    <button id="fvg-toggle-btn" class="btn btn-toggle active">FVG 開</button>
                    <button id="draw-line-btn" class="btn btn-tool">畫線</button>
                    <button id="clear-lines-btn" class="btn btn-danger">清除線</button>
                </div>
            </div>
        </div>
        
        <!-- 時間刻度分頁 -->
        <div class="timeframe-tabs">
            <button class="tab-btn" data-timeframe="M1">M1</button>
            <button class="tab-btn" data-timeframe="M5">M5</button>
            <button class="tab-btn active" data-timeframe="M15">M15</button>
            <button class="tab-btn" data-timeframe="H1">H1</button>
            <button class="tab-btn" data-timeframe="H4">H4</button>
            <button class="tab-btn" data-timeframe="D1">D1</button>
        </div>
        
        <!-- 播放控制面板 -->
        <div class="playback-panel">
            <div class="playback-controls">
                <button id="play-btn" class="btn btn-play">開始</button>
                <button id="pause-btn" class="btn btn-pause" disabled>暫停</button>
                
                <div class="speed-selector">
                    <label>播放速度：</label>
                    <select id="speed-select">
                        <option value="1">1秒/根</option>
                        <option value="2">2秒/根</option>
                        <option value="5" selected>5秒/根</option>
                        <option value="10">10秒/根</option>
                        <option value="20">20秒/根</option>
                        <option value="30">30秒/根</option>
                    </select>
                </div>
                
                <div class="playback-info">
                    <span id="playback-time">播放時間: --</span>
                    <span id="countdown">下一根: --</span>
                </div>
            </div>
        </div>
        
        <!-- 圖表容器 -->
        <div class="chart-container">
            <div id="chart"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在載入圖表資料...</p>
            </div>
        </div>
        
        <!-- 狀態列 -->
        <div class="status-bar">
            <div class="status-info">
                <span id="candle-count">K線數量: --</span>
                <span id="fvg-count">FVG數量: --</span>
                <span id="time-range">時間範圍: --</span>
                <span id="dst-status">時區狀態: --</span>
            </div>
            <div class="hover-info">
                <span id="hover-data">將滑鼠移至圖表查看詳細資料</span>
            </div>
        </div>
    </div>
    
    <!-- 引入 Lightweight Charts - 使用多個備用 CDN -->
    <script>
        // 檢查並載入 Lightweight Charts
        function loadLightweightCharts() {
            return new Promise((resolve, reject) => {
                const cdnList = [
                    'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.1.3/lightweight-charts.standalone.production.min.js'
                ];
                
                let currentIndex = 0;
                
                function tryLoad() {
                    if (currentIndex >= cdnList.length) {
                        reject(new Error('所有 CDN 都無法載入 Lightweight Charts'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    
                    script.onload = () => {
                        console.log('Lightweight Charts 載入成功:', cdnList[currentIndex]);
                        // 檢查 API 是否可用
                        if (typeof LightweightCharts !== 'undefined' && 
                            typeof LightweightCharts.createChart === 'function') {
                            resolve();
                        } else {
                            console.warn('Lightweight Charts API 不完整');
                            currentIndex++;
                            tryLoad();
                        }
                    };
                    
                    script.onerror = () => {
                        console.warn('CDN 載入失敗:', cdnList[currentIndex]);
                        currentIndex++;
                        tryLoad();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoad();
            });
        }
        
        // 載入多個腳本的輔助函數
        function loadModules(modules, callback) {
            let loaded = 0;
            modules.forEach(module => {
                const script = document.createElement('script');
                script.src = module;
                script.onload = () => {
                    loaded++;
                    if (loaded === modules.length) {
                        callback();
                    }
                };
                script.onerror = () => {
                    console.error(`模組載入失敗: ${module}`);
                    alert(`系統模組載入失敗: ${module}`);
                };
                document.head.appendChild(script);
            });
        }

        // 載入完成後初始化
        loadLightweightCharts()
            .then(() => {
                console.log('開始載入主程式...');
                // 先載入聚合器
                const aggregatorScript = document.createElement('script');
                aggregatorScript.src = 'candleAggregator.js';
                
                aggregatorScript.onload = () => {
                    console.log('CandleAggregator 載入成功');
                    // 載入配置和管理器模組
                    loadModules(['config.js', 'fvg-renderer.js', 'chart-manager.js', 'data-manager.js', 'playback-manager.js', 'event-manager.js'], () => {
                        // 最後載入主程式
                        const script = document.createElement('script');
                        script.src = 'script.js';
                        document.head.appendChild(script);
                    });
                };
                
                aggregatorScript.onerror = () => {
                    console.error('CandleAggregator 載入失敗');
                    alert('系統載入失敗，請重新整理頁面。');
                };
                
                document.head.appendChild(aggregatorScript);
            })
            .catch(error => {
                console.error('圖表庫載入失敗:', error);
                alert('圖表庫載入失敗，請檢查網路連線或嘗試重新整理頁面。');
            });
    </script>
</body>
</html>