<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易圖表系統 - FVG 半透明修復演示</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* FVG 演示專用樣式 */
        .fvg-demo-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 300px;
        }
        
        .fvg-demo-panel h4 {
            margin: 0 0 15px 0;
            color: #4CAF50;
            text-align: center;
            font-size: 16px;
        }
        
        .demo-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .demo-controls {
            margin: 15px 0;
        }
        
        .demo-controls label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .demo-controls select, .demo-controls button {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .mode-indicator {
            text-align: center;
            padding: 8px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .mode-original {
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ef5350;
        }
        
        .mode-fixed {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        
        .issue-explanation {
            background: #fff3e0;
            border: 1px solid #ff9800;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 13px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- FVG 演示控制面板 -->
    <div class="fvg-demo-panel">
        <h4>FVG 半透明修復演示</h4>
        
        <div class="mode-indicator" id="mode-indicator">
            當前模式: 載入中...
        </div>
        
        <div class="issue-explanation">
            <strong>問題說明:</strong><br>
            原版 FVG 透明度會隨高度變化，高的 FVG 看起來更淡，矮的 FVG 看起來更深。<br><br>
            <strong>解決方案:</strong><br>
            使用像素高度計算線條數量，確保所有 FVG 透明度一致。
        </div>
        
        <div class="demo-controls">
            <button id="toggle-mode-btn" class="btn btn-primary">切換渲染模式</button>
            <button id="generate-test-fvg" class="btn btn-secondary">生成測試 FVG</button>
        </div>
        
        <div class="demo-info">
            <div><strong>當前狀態:</strong></div>
            <div>渲染模式: <span id="current-mode">--</span></div>
            <div>FVG 數量: <span id="demo-fvg-count">0</span></div>
            <div>系列數量: <span id="demo-series-count">0</span></div>
        </div>
    </div>

    <!-- 指標選擇側邊欄 -->
    <div id="indicators-sidebar" class="indicators-sidebar">
        <div class="sidebar-header">
            <h3>技術指標</h3>
            <button id="close-sidebar-btn" class="close-btn">&times;</button>
        </div>
        
        <div class="sidebar-content">
            <!-- 價格動作指標 -->
            <div class="indicator-category">
                <h4>價格動作</h4>
                <div class="indicator-list">
                    <label class="indicator-item">
                        <input type="checkbox" id="fvg-checkbox" checked>
                        <span class="indicator-name">Fair Value Gap (FVG)</span>
                        <button class="settings-btn" data-indicator="fvg" title="設定參數">⚙</button>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 背景遮罩 -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div class="container">
        <!-- 頂部控制面板 -->
        <div class="control-panel">
            <div class="info-section">
                <h1>FVG 半透明修復演示</h1>
                <div class="date-info">
                    <span id="current-date">載入中...</span>
                    <span id="market-info">載入中...</span>
                </div>
            </div>
            
            <div class="controls">
                <!-- 漢堡選單按鈕 -->
                <button id="indicators-menu-btn" class="btn btn-menu" title="技術指標">
                    <span class="hamburger-icon">☰</span>
                </button>
                
                <!-- 操作按鈕 -->
                <div class="action-buttons">
                    <button id="refresh-btn" class="btn btn-primary">隨機日期</button>
                    <button id="reset-zoom-btn" class="btn btn-secondary">重置縮放</button>
                    <button id="fvg-toggle-btn" class="btn btn-toggle active">FVG 開</button>
                </div>
            </div>
        </div>
        
        <!-- 時間刻度分頁 -->
        <div class="timeframe-tabs">
            <button class="tab-btn" data-timeframe="M1">M1</button>
            <button class="tab-btn" data-timeframe="M5">M5</button>
            <button class="tab-btn active" data-timeframe="M15">M15</button>
            <button class="tab-btn" data-timeframe="H1">H1</button>
            <button class="tab-btn" data-timeframe="H4">H4</button>
            <button class="tab-btn" data-timeframe="D1">D1</button>
        </div>
        
        <!-- 播放控制面板 -->
        <div class="playback-panel">
            <div class="playback-controls">
                <button id="play-btn" class="btn btn-play">開始</button>
                <button id="pause-btn" class="btn btn-pause" disabled>暫停</button>
                
                <div class="speed-selector">
                    <label>播放速度：</label>
                    <select id="speed-select">
                        <option value="1">1秒/根</option>
                        <option value="2">2秒/根</option>
                        <option value="5" selected>5秒/根</option>
                        <option value="10">10秒/根</option>
                        <option value="20">20秒/根</option>
                        <option value="30">30秒/根</option>
                    </select>
                </div>
                
                <div class="playback-info">
                    <span id="playback-time">播放時間: --</span>
                    <span id="countdown">下一根: --</span>
                </div>
            </div>
        </div>
        
        <!-- 圖表容器 -->
        <div class="chart-container">
            <div id="chart"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在載入圖表資料...</p>
            </div>
        </div>
        
        <!-- 狀態列 -->
        <div class="status-bar">
            <div class="status-info">
                <span id="candle-count">K線數量: --</span>
                <span id="fvg-count">FVG數量: --</span>
                <span id="time-range">時間範圍: --</span>
                <span id="dst-status">時區狀態: --</span>
            </div>
            <div class="hover-info">
                <span id="hover-data">將滑鼠移至圖表查看詳細資料</span>
            </div>
        </div>
    </div>
    
    <!-- 引入 Lightweight Charts - 使用多個備用 CDN -->
    <script>
        // 檢查並載入 Lightweight Charts
        function loadLightweightCharts() {
            return new Promise((resolve, reject) => {
                const cdnList = [
                    'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.1.3/lightweight-charts.standalone.production.min.js'
                ];
                
                let currentIndex = 0;
                
                function tryLoad() {
                    if (currentIndex >= cdnList.length) {
                        reject(new Error('所有 CDN 都無法載入 Lightweight Charts'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnList[currentIndex];
                    
                    script.onload = () => {
                        console.log('Lightweight Charts 載入成功:', cdnList[currentIndex]);
                        // 檢查 API 是否可用
                        if (typeof LightweightCharts !== 'undefined' && 
                            typeof LightweightCharts.createChart === 'function') {
                            resolve();
                        } else {
                            console.warn('Lightweight Charts API 不完整');
                            currentIndex++;
                            tryLoad();
                        }
                    };
                    
                    script.onerror = () => {
                        console.warn('CDN 載入失敗:', cdnList[currentIndex]);
                        currentIndex++;
                        tryLoad();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryLoad();
            });
        }
        
        // 載入完成後初始化
        loadLightweightCharts()
            .then(() => {
                console.log('開始載入主程式...');
                // 先載入聚合器
                const aggregatorScript = document.createElement('script');
                aggregatorScript.src = 'candleAggregator.js';
                
                aggregatorScript.onload = () => {
                    console.log('CandleAggregator 載入成功');
                    // 載入 FVG 演示專用腳本
                    const script = document.createElement('script');
                    script.src = 'script_fvg_demo.js';
                    document.head.appendChild(script);
                };
                
                aggregatorScript.onerror = () => {
                    console.error('CandleAggregator 載入失敗');
                    alert('系統載入失敗，請重新整理頁面。');
                };
                
                document.head.appendChild(aggregatorScript);
            })
            .catch(error => {
                console.error('圖表庫載入失敗:', error);
                alert('圖表庫載入失敗，請檢查網路連線或嘗試重新整理頁面。');
            });
    </script>
</body>
</html>