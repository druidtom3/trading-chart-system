<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightweight Charts v5.0 升級測試</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .version-selector {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .version-selector h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .version-option {
            margin: 5px 0;
        }
        
        .version-option input[type="radio"] {
            margin-right: 8px;
        }
        
        .version-option label {
            cursor: pointer;
            font-size: 14px;
        }
        
        .performance-stats {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 版本選擇器 -->
    <div class="version-selector">
        <h4>版本選擇</h4>
        <div class="version-option">
            <input type="radio" id="v4" name="version" value="v4.1.3" checked>
            <label for="v4">v4.1.3 (LineSeries)</label>
        </div>
        <div class="version-option">
            <input type="radio" id="v5" name="version" value="v5.0">
            <label for="v5">最新版 (增強模式)</label>
        </div>
        <button id="switch-version" class="btn btn-primary" style="margin-top: 10px; width: 100%;">
            切換版本
        </button>
    </div>

    <!-- 性能統計 -->
    <div class="performance-stats">
        <div>版本: <span id="current-version">v4.1.3</span></div>
        <div>FVG 數量: <span id="fvg-count">0</span></div>
        <div>系列數量: <span id="series-count">0</span></div>
        <div>估計內存: <span id="memory-usage">0KB</span></div>
        <div>渲染模式: <span id="render-mode">LineSeries</span></div>
    </div>

    <!-- 載入遮罩 -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div>
            <div class="spinner"></div>
            <p>正在切換版本...</p>
        </div>
    </div>

    <!-- 指標選擇側邊欄 -->
    <div id="indicators-sidebar" class="indicators-sidebar">
        <div class="sidebar-header">
            <h3>技術指標</h3>
            <button id="close-sidebar-btn" class="close-btn">&times;</button>
        </div>
        
        <div class="sidebar-content">
            <!-- 價格動作指標 -->
            <div class="indicator-category">
                <h4>價格動作</h4>
                <div class="indicator-list">
                    <label class="indicator-item">
                        <input type="checkbox" id="fvg-checkbox" checked>
                        <span class="indicator-name">Fair Value Gap (FVG)</span>
                        <button class="settings-btn" data-indicator="fvg" title="設定參數">⚙</button>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 背景遮罩 -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div class="container">
        <!-- 頂部控制面板 -->
        <div class="control-panel">
            <div class="info-section">
                <h1>Lightweight Charts 升級測試</h1>
                <div class="date-info">
                    <span id="current-date">載入中...</span>
                    <span id="market-info">載入中...</span>
                </div>
            </div>
            
            <div class="controls">
                <!-- 漢堡選單按鈕 -->
                <button id="indicators-menu-btn" class="btn btn-menu" title="技術指標">
                    <span class="hamburger-icon">☰</span>
                </button>
                
                <!-- 操作按鈕 -->
                <div class="action-buttons">
                    <button id="refresh-btn" class="btn btn-primary">隨機日期</button>
                    <button id="reset-zoom-btn" class="btn btn-secondary">重置縮放</button>
                    <button id="fvg-toggle-btn" class="btn btn-toggle active">FVG 開</button>
                    <button id="performance-test-btn" class="btn btn-info">性能測試</button>
                </div>
            </div>
        </div>
        
        <!-- 圖表容器 -->
        <div class="chart-container">
            <div id="chart"></div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在載入圖表資料...</p>
            </div>
        </div>
        
        <!-- 狀態列 -->
        <div class="status-bar">
            <div class="status-info">
                <span id="candle-count">K線數量: --</span>
                <span id="fvg-count-display">FVG數量: --</span>
                <span id="time-range">時間範圍: --</span>
            </div>
            <div class="hover-info">
                <span id="hover-data">將滑鼠移至圖表查看詳細資料</span>
            </div>
        </div>
    </div>
    
    <!-- 版本切換腳本 -->
    <script>
        let currentVersion = 'v4.1.3';
        let chartApp = null;
        let performanceMonitor = null;
        
        // 動態載入腳本
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 移除舊腳本
                const oldScript = document.querySelector(`script[src*="${src.split('/').pop()}"]`);
                if (oldScript) {
                    oldScript.remove();
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // 載入 Lightweight Charts 版本
        async function loadChartsVersion(version) {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.remove('hidden');
            
            try {
                if (version === 'v5.0') {
                    // 載入最新版本（實際上可能是 v4.2.x 或更高版本）
                    try {
                        await loadScript('https://cdn.jsdelivr.net/npm/lightweight-charts@latest/dist/lightweight-charts.standalone.production.js');
                        console.log('Lightweight Charts 最新版本載入成功');
                        
                        // 檢查是否真的是 v5.0+ API
                        if (typeof LightweightCharts.CandlestickSeries === 'undefined') {
                            console.warn('載入的版本不支持 v5.0 API，可能仍是 v4.x');
                            // 不需要重新載入，因為 v5.0 腳本有回退機制
                        }
                        
                        // 嘗試載入 Primitives（可能不存在）
                        try {
                            await loadScript('https://cdn.jsdelivr.net/npm/lightweight-charts@latest/dist/plugins/primitives.standalone.production.js');
                            console.log('Primitives 插件載入成功');
                        } catch (error) {
                            console.warn('Primitives 插件不存在或載入失敗 - 這是正常的，將使用 LineSeries 回退模式:', error);
                        }
                    } catch (error) {
                        console.error('最新版本載入失敗，回退到 v4.1.3:', error);
                        await loadScript('https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js');
                    }
                } else {
                    // 載入 v4.1.3
                    await loadScript('https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js');
                }
                
                // 載入聚合器
                await loadScript('candleAggregator.js');
                
                // 載入 FVG 系列（v5.0）
                if (version === 'v5.0') {
                    await loadScript('fvg_series.js');
                }
                
            } catch (error) {
                console.error('腳本載入失敗:', error);
                alert('版本載入失敗，請重試');
                loadingOverlay.classList.add('hidden');
                return false;
            }
            
            loadingOverlay.classList.add('hidden');
            return true;
        }
        
        // 初始化圖表應用
        async function initializeChart(version) {
            try {
                // 清理舊實例
                if (chartApp && chartApp.chart) {
                    chartApp.chart.remove();
                    chartApp = null;
                }
                
                if (version === 'v5.0') {
                    // 載入 v5.0 腳本
                    await loadScript('script_v5.js');
                    chartApp = new TradingChartAppV5();
                } else {
                    // 載入 v4.1.3 腳本  
                    await loadScript('script.js');
                    chartApp = new TradingChartApp();
                }
                
                // 啟動性能監控
                startPerformanceMonitor();
                
            } catch (error) {
                console.error('圖表初始化失敗:', error);
                alert('圖表初始化失敗，請重試');
            }
        }
        
        // 性能監控
        function startPerformanceMonitor() {
            performanceMonitor = setInterval(() => {
                updatePerformanceStats();
            }, 2000);
        }
        
        function updatePerformanceStats() {
            if (!chartApp) return;
            
            let stats;
            if (typeof chartApp.getPerformanceStats === 'function') {
                stats = chartApp.getPerformanceStats();
            } else {
                // v4.1.3 回退統計
                stats = {
                    version: 'v4.1.3',
                    usePrimitives: false,
                    fvgCount: chartApp.currentData?.fvgs?.length || 0,
                    seriesCount: chartApp.fvgRectangles?.length || 0,
                    memoryEstimate: `~${Math.ceil((chartApp.fvgRectangles?.length || 0) * 2)}KB`
                };
            }
            
            document.getElementById('current-version').textContent = stats.version;
            document.getElementById('fvg-count').textContent = stats.fvgCount;
            document.getElementById('series-count').textContent = stats.seriesCount;
            document.getElementById('memory-usage').textContent = stats.memoryEstimate;
            document.getElementById('render-mode').textContent = stats.usePrimitives ? 'Primitives' : 'LineSeries';
        }
        
        // 版本切換處理
        document.getElementById('switch-version').addEventListener('click', async () => {
            const selectedVersion = document.querySelector('input[name="version"]:checked').value;
            
            if (selectedVersion === currentVersion) {
                alert('已經是當前版本');
                return;
            }
            
            console.log(`切換版本: ${currentVersion} → ${selectedVersion}`);
            
            // 停止性能監控
            if (performanceMonitor) {
                clearInterval(performanceMonitor);
            }
            
            // 載入新版本
            const success = await loadChartsVersion(selectedVersion);
            if (success) {
                currentVersion = selectedVersion;
                await initializeChart(selectedVersion);
                console.log(`版本切換成功: ${selectedVersion}`);
            }
        });
        
        // 性能測試
        document.getElementById('performance-test-btn').addEventListener('click', () => {
            if (!chartApp) {
                alert('圖表尚未初始化');
                return;
            }
            
            const startTime = performance.now();
            
            // 執行 FVG 重繪測試
            for (let i = 0; i < 5; i++) {
                chartApp.clearFVGs();
                chartApp.drawFVGs();
            }
            
            const endTime = performance.now();
            const duration = (endTime - startTime).toFixed(2);
            
            alert(`性能測試完成\\n版本: ${currentVersion}\\n5次重繪耗時: ${duration}ms\\n平均: ${(duration/5).toFixed(2)}ms`);
        });
        
        // 初始載入 v4.1.3
        window.addEventListener('load', async () => {
            await loadChartsVersion('v4.1.3');
            await initializeChart('v4.1.3');
        });
    </script>
</body>
</html>